(function(){(this||window).webpackJsonp.registerAbsMids({"esri/tasks/support/FeatureSet":1416,"esri/views/layers/LayerView":1471,"esri/geometry/support/normalizeUtils":1473,"esri/tasks/geometry/cut":1474,"esri/tasks/geometry/simplify":1475,"esri/views/3d/layers/LayerView3D":1476,"esri/views/3d/layers/support/layerViewUpdatingProperties":1482,"esri/renderers/visualVariables/support/visualVariableUtils":1493,"esri/tasks/support/AttachmentQuery":1506,"esri/tasks/support/RelationshipQuery":1511,"esri/views/3d/layers/support/attributeUtils":1518,"esri/views/3d/webgl-engine/lib/HighlightSet":1529,"esri/layers/support/PromiseQueue":1531,"esri/views/3d/webgl-engine/materials/component/Parameters":1545,"esri/views/3d/webgl-engine/materials/component/VertexBufferLayout":1546,"esri/layers/graphics/controllers/I3SOnDemandController":1564,"esri/views/3d/layers/i3s/I3SFrameTask":1565,"esri/views/3d/layers/i3s/I3SIndex":1566,"esri/views/3d/layers/i3s/I3SLodHandling":1567,"esri/views/3d/layers/i3s/I3SNodeLoader":1568,"esri/views/3d/layers/i3s/I3SStreamDataController":1569,"esri/views/3d/layers/i3s/I3SViewportQueries":1570,"esri/views/3d/layers/I3SMeshView3D":1623,"esri/views/3d/layers/i3s/Highlights":1624,"esri/views/3d/layers/i3s/I3SElevationProvider":1625,"esri/views/3d/layers/i3s/IDBCache":1626,"esri/views/3d/webgl-engine/materials/component/index":1627,"esri/views/3d/webgl-engine/materials/component/ComponentMaterial":1628,"esri/views/3d/webgl-engine/materials/component/ComponentGLMaterial":1629,"esri/views/3d/webgl-engine/materials/internal/TextureBinding":1630,"esri/views/3d/webgl-engine/materials/renderers/PreinterleavedRenderer":1631,"esri/views/3d/layers/IntegratedMeshLayerView3D":2449})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[46,72,106],{1416:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(1),r(2),r(42),r(84),r(26),r(8),r(14),r(0),r(39),r(71),r(550)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h){var p=new a.default({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent"}),f=function(e){function t(t){var r=e.call(this,t)||this;return r.displayFieldName=null,r.exceededTransferLimit=!1,r.features=[],r.fields=null,r.geometryType=null,r.hasM=!1,r.hasZ=!1,r.queryGeometry=null,r.spatialReference=null,r}return i(t,e),t.prototype.readFeatures=function(e,t){for(var r=u.fromJSON(t.spatialReference),i=[],n=0;n<e.length;n++){var a=e[n],s=o.fromJSON(a),d=a.geometry&&a.geometry.spatialReference;l.isSome(s.geometry)&&!d&&(s.geometry.spatialReference=r),i.push(s)}return i},t.prototype.writeGeometryType=function(e,t,r,i){if(e)p.write(e,t,r,i);else{var n=this.features;if(n)for(var o=0,a=n;o<a.length;o++){var s=a[o];if(s&&l.isSome(s.geometry))return void p.write(s.geometry.type,t,r,i)}}},t.prototype.writeSpatialReference=function(e,t,r,i){if(e)t.spatialReference=e.toJSON();else{var n=this.features;if(n)for(var o=0,a=n;o<a.length;o++){var s=a[o];s&&l.isSome(s.geometry)&&s.geometry.spatialReference&&(t.spatialReference=s.geometry.spatialReference.toJSON())}}},t.prototype.toJSON=function(e){var t=this.write(null);if(t.features&&Array.isArray(e)&&e.length>0)for(var r=0;r<t.features.length;r++){var i=t.features[r];if(i.geometry){var n=e&&e[r];i.geometry=n&&n.toJSON()||i.geometry}}return t},t.prototype.quantize=function(e){for(var t=e.scale,r=t[0],i=t[1],n=e.translate,o=n[0],a=n[1],s=this.features,d=this._getQuantizationFunction(this.geometryType,function(e){return Math.round((e-o)/r)},function(e){return Math.round((a-e)/i)}),u=0,c=s.length;u<c;u++)d(l.expect(s[u].geometry))||(s.splice(u,1),u--,c--);return this.transform=e,this},t.prototype.unquantize=function(){var e=this,t=e.geometryType,r=e.features,i=e.transform;if(!i)return this;for(var n=i.translate,o=n[0],a=n[1],s=i.scale,d=s[0],u=s[1],c=this._getHydrationFunction(t,function(e){return e*d+o},function(e){return a-e*u}),h=0,p=r;h<p.length;h++){var f=p[h].geometry;l.isSome(f)&&c(f)}return this},t.prototype._quantizePoints=function(e,t,r){for(var i,n,o=[],a=0,s=e.length;a<s;a++){var l=e[a];if(a>0){var d=t(l[0]),u=r(l[1]);d===i&&u===n||(o.push([d-i,u-n]),i=d,n=u)}else i=t(l[0]),n=r(l[1]),o.push([i,n])}return o.length>0?o:null},t.prototype._getQuantizationFunction=function(e,t,r){var i=this;return"point"===e?function(e){return e.x=t(e.x),e.y=r(e.y),e}:"polyline"===e||"polygon"===e?function(e){for(var n=c.isPolygon(e)?e.rings:e.paths,o=[],a=0,s=n.length;a<s;a++){var l=n[a],d=i._quantizePoints(l,t,r);d&&o.push(d)}return o.length>0?(c.isPolygon(e)?e.rings=o:e.paths=o,e):null}:"multipoint"===e?function(e){var n;return(n=i._quantizePoints(e.points,t,r)).length>0?(e.points=n,e):null}:"extent"===e?function(e){return e}:void 0},t.prototype._getHydrationFunction=function(e,t,r){return"point"===e?function(e){e.x=t(e.x),e.y=r(e.y)}:"polyline"===e||"polygon"===e?function(e){for(var i,n,o=c.isPolygon(e)?e.rings:e.paths,a=0,s=o.length;a<s;a++)for(var l=o[a],d=0,u=l.length;d<u;d++){var h=l[d];d>0?(i+=h[0],n+=h[1]):(i=h[0],n=h[1]),h[0]=t(i),h[1]=r(n)}}:"extent"===e?function(e){e.xmin=t(e.xmin),e.ymin=r(e.ymin),e.xmax=t(e.xmax),e.ymax=r(e.ymax)}:"multipoint"===e?function(e){for(var i,n,o=e.points,a=0,s=o.length;a<s;a++){var l=o[a];a>0?(i+=l[0],n+=l[1]):(i=l[0],n=l[1]),l[0]=t(i),l[1]=r(n)}}:void 0},r([d.property({type:String,json:{write:!0}})],t.prototype,"displayFieldName",void 0),r([d.property({type:Boolean,json:{write:{overridePolicy:function(e){return{enabled:e}}}}})],t.prototype,"exceededTransferLimit",void 0),r([d.property({type:[o],json:{write:!0}})],t.prototype,"features",void 0),r([d.reader("features")],t.prototype,"readFeatures",null),r([d.property({type:[h],json:{write:!0}})],t.prototype,"fields",void 0),r([d.property({type:["point","multipoint","polyline","polygon","extent","mesh"],json:{read:{reader:p.read}}})],t.prototype,"geometryType",void 0),r([d.writer("geometryType")],t.prototype,"writeGeometryType",null),r([d.property({type:Boolean,json:{write:{overridePolicy:function(e){return{enabled:e}}}}})],t.prototype,"hasM",void 0),r([d.property({type:Boolean,json:{write:{overridePolicy:function(e){return{enabled:e}}}}})],t.prototype,"hasZ",void 0),r([d.property({types:n.geometryTypes,json:{read:c.fromJSON,write:!0}})],t.prototype,"queryGeometry",void 0),r([d.property({type:u,json:{write:!0}})],t.prototype,"spatialReference",void 0),r([d.writer("spatialReference")],t.prototype,"writeSpatialReference",null),r([d.property({json:{write:!0}})],t.prototype,"transform",void 0),r([d.subclass("esri.tasks.support.FeatureSet")],t)}(d.declared(s));return f.prototype.toJSON.isDefaultToJSON=!0,f||(f={}),f}.apply(null,i))||(e.exports=n)},1471:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(1),r(37),r(348),r(255),r(12),r(201),r(9),r(0)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u){return function(e){function t(t){var r=e.call(this)||this;return r.layer=null,r.parent=null,r.view=null,r}return r(t,e),t.prototype.initialize=function(){var e=this;this.addResolvingPromise(this.layer),this.when().catch(function(t){if("layerview:create-error"!==t.name){var r=e.layer&&e.layer.id||"no id",i=e.layer&&e.layer.title||"no title";return s.getLogger(e.declaredClass).error("#resolve()","Failed to resolve layer view (layer title: '"+i+"', id: '"+r+"')",t),d.reject(t)}})},t.prototype.destroy=function(){this.layer=this.view=this.parent=null},Object.defineProperty(t.prototype,"suspended",{get:function(){return!this.canResume()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!this.suspended&&this.isUpdating()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return!0===this.get("layer.visible")},set:function(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fullOpacity",{get:function(){var e=function(e){return null==e?1:e};return e(this.get("layer.opacity"))*e(this.get("parent.fullOpacity"))},enumerable:!0,configurable:!0}),t.prototype.canResume=function(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.get("layer.loaded")&&this.visible||!1},t.prototype.isUpdating=function(){return!1},i([u.property()],t.prototype,"layer",void 0),i([u.property()],t.prototype,"parent",void 0),i([u.property({readOnly:!0,dependsOn:["view","visible","layer.loaded","parent.suspended"]})],t.prototype,"suspended",null),i([u.property({type:Boolean,dependsOn:["suspended"],readOnly:!0})],t.prototype,"updating",null),i([u.property()],t.prototype,"view",void 0),i([u.property({dependsOn:["layer.visible"]})],t.prototype,"visible",null),i([u.property({dependsOn:["layer.opacity","parent.fullOpacity"]})],t.prototype,"fullOpacity",null),i([u.subclass("esri.views.layers.LayerView")],t)}(u.declared(o,n,a.Identifiable,l))}.apply(null,i))||(e.exports=n)},1473:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(11),r(13),r(97),r(15),r(12),r(14),r(9),r(63),r(96),r(39),r(94),r(56),r(1474),r(1475)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h,p,f,g){function y(e){return"polygon"===e.type}function m(e){return"polygon"===e[0].type}function v(e){return"polyline"===e[0].type}function _(e){return y(e)?e.rings:e.paths}function b(e,t){return Math.ceil((e-t)/(2*t))}function x(e,t){for(var r=0,i=_(e);r<i.length;r++)for(var n=0,o=i[r];n<o.length;n++){o[n][0]+=t}return e}function w(e){for(var t=[],r=0,i=0,n=0;n<e.length;n++){for(var o=e[n],a=null,s=0;s<o.length;s++)a=o[s],t.push(a),0===s?i=r=a[0]:(r=Math.min(r,a[0]),i=Math.max(i,a[0]));a&&t.push([(r+i)/2,0])}return t}function C(e,t){if(!(e instanceof u||e instanceof d)){var r="straightLineDensify: the input geometry is neither polyline nor polygon";throw P.error(r),new o(r)}for(var i=[],n=0,a=_(e);n<a.length;n++){var s=a[n],l=[];i.push(l),l.push([s[0][0],s[0][1]]);for(var c=0;c<s.length-1;c++){var h=s[c][0],p=s[c][1],f=s[c+1][0],g=s[c+1][1],m=Math.sqrt((f-h)*(f-h)+(g-p)*(g-p)),v=(g-p)/m,b=(f-h)/m,x=m/t;if(x>1){for(var w=1;w<=x-1;w++){var C=w*t,S=b*C+h,D=v*C+p;l.push([S,D])}var I=(m+Math.floor(x-1)*t)/2,M=b*I+h,N=v*I+p;l.push([M,N])}l.push([f,g])}}return y(e)?new d({rings:i,spatialReference:e.spatialReference}):new u({paths:i,spatialReference:e.spatialReference})}function S(e,t,r){if(t){var i=C(e,1e6);e=p.webMercatorToGeographic(i,!0)}return r&&(e=x(e,r)),e}function D(e,t,r){var i;if(Array.isArray(e)){if((i=e[0])>t){var n=b(i,t);e[0]=i+n*(-2*t)}else if(i<r){n=b(i,r);e[0]=i+n*(-2*r)}}else if((i=e.x)>t){n=b(i,t);e=e.clone().offset(n*(-2*t),0)}else if(i<r){n=b(i,r);e=e.clone().offset(n*(-2*r),0)}return e}function I(e,t){for(var r=-1,i=0;i<t.cutIndexes.length;i++)!function(i){for(var n=t.cutIndexes[i],o=t.geometries[i],a=_(o),s=0;s<a.length;s++)!function(e){var t=a[e];t.some(function(r){if(r[0]<180)return!0;for(var i=0,n=0;n<t.length;n++){var a=t[n][0];i=a>i?a:i}for(var s=-360*b(i=Number(i.toFixed(9)),180),l=0;l<t.length;l++){var d=o.getPoint(e,l);o.setPoint(e,l,d.clone().offset(s,0))}return!0})}(s);if(n===r){if(m(e))for(var l=0,d=_(o);l<d.length;l++){var u=d[l];e[n]=e[n].addRing(u)}else if(v(e))for(var c=0,h=_(o);c<h.length;c++){var p=h[c];e[n]=e[n].addPath(p)}}else r=n,e[n]=o}(i);return e}Object.defineProperty(t,"__esModule",{value:!0});var P=a.getLogger("esri.geometry.support.normalizeUtils"),M={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:new u({paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:c.WebMercator}),minus180Line:new u({paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:c.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new u({paths:[[[180,-180],[180,180]]],spatialReference:c.WebMercator}),minus180Line:new u({paths:[[[-180,-180],[-180,180]]],spatialReference:c.WebMercator})}};t.straightLineDensify=C,t.normalizeCentralMeridian=function e(t,o,a){return i(this,void 0,void 0,function(){var i,c,y,m,v,_,w,C,P,N,O,V,T,L,E,R,A,j,F,G,B,U,k,z,q,H,Q,W,J,K,X,Y,Z,$,ee,te,re;return r(this,function(r){switch(r.label){case 0:if(!Array.isArray(t))return[2,e([t],o)];for(i=o?o.url:n.geometryServiceUrl,N=0,O=[],V=[],T=0,L=t;T<L.length;T++)E=L[T],s.isNone(E)?V.push(E):(c||(c=E.spatialReference,y=h.getInfo(c),m=c.isWebMercator,v=M[w=m?102100:4326].maxX,_=M[w].minX,C=M[w].plus180Line,P=M[w].minus180Line),y?"mesh"===E.type?V.push(E):"point"===E.type?V.push(D(E.clone(),v,_)):"multipoint"===E.type?((R=E.clone()).points=R.points.map(function(e){return D(e,v,_)}),V.push(R)):"extent"===E.type?(j=E.clone(),A=j._normalize(!1,!1,y),V.push(A.rings?new d(A):A)):E.extent?(j=E.extent,F=b(j.xmin,_),B=0==(G=F*(2*v))?E.clone():x(E.clone(),G),j.offset(G,0),j.intersects(C)&&j.xmax!==v?(N=j.xmax>N?j.xmax:N,B=S(B,m),O.push(B),V.push("cut")):j.intersects(P)&&j.xmin!==_?(N=j.xmax*(2*v)>N?j.xmax*(2*v):N,B=S(B,m,360),O.push(B),V.push("cut")):V.push(B)):V.push(E.clone()):V.push(E));for(U=b(N,v),k=-90,z=U,q=new u;U>0;)H=360*U-180,q.addPath([[H,k],[H,-1*k]]),k*=-1,U--;return O.length>0&&z>0?[4,f.cut(i,O,q,a)]:[3,3];case 1:for(Q=r.sent(),W=I(O,Q),J=[],K=[],ee=0;ee<V.length;ee++)"cut"!==(te=V[ee])?K.push(te):(re=W.shift(),X=t[ee],s.isSome(X)&&"polygon"===X.type&&X.rings&&X.rings.length>1&&re.rings.length>=X.rings.length?(J.push(re),K.push("simplify")):K.push(m?p.geographicToWebMercator(re):re));return J.length?[4,g.simplify(i,J,a)]:[2,K];case 2:for(Y=r.sent(),Z=[],ee=0;ee<K.length;ee++)"simplify"!==(te=K[ee])?Z.push(te):Z.push(m?p.geographicToWebMercator(Y.shift()):Y.shift());return[2,Z];case 3:for($=[],ee=0;ee<V.length;ee++)"cut"!==(te=V[ee])?$.push(te):(re=O.shift(),$.push(!0===m?p.geographicToWebMercator(re):re));return[2,l.resolve($)]}})})},t.getDenormalizedExtent=function(e){var t;if(!e)return null;var r=e.extent;if(!r)return null;var i=e.spatialReference&&h.getInfo(e.spatialReference);if(!i)return r;var n,o=i.valid,a=o[0],s=o[1],l=2*s,d=r.width,u=r.xmin,c=r.xmax;if(u=(t=[c,u])[0],c=t[1],"extent"===e.type||0===d||d<=s||d>l||u<a||c>s)return r;switch(e.type){case"polygon":if(!(e.rings.length>1))return r;n=w(e.rings);break;case"polyline":if(!(e.paths.length>1))return r;n=w(e.paths);break;case"multipoint":n=e.points}for(var p=r.clone(),f=0;f<n.length;f++){var g=n[f][0];g<0?(g+=s,c=Math.max(g,c)):(g-=s,u=Math.min(g,u))}return p.xmin=u,p.xmax=c,p.width<d?(p.xmin-=s,p.xmax-=s,p):r},t.normalizeMapX=function(e,t){var r=h.getInfo(t);if(r){var i=r.valid,n=i[0],o=i[1],a=o-n;if(e<n)for(;e<n;)e+=a;if(e>o)for(;e>o;)e-=a}return e}}.apply(null,i))||(e.exports=n)},1474:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(7),r(13),r(11),r(42),r(48),r(31),r(71)],void 0===(n=function(e,t,r,i,n,o,a,s,l){Object.defineProperty(t,"__esModule",{value:!0}),t.cut=function(e,t,d,u){return i(this,void 0,void 0,function(){var i,c,h,p,f,g,y;return n(this,function(n){switch(n.label){case 0:return i="string"==typeof e?s.urlToObject(e):e,c=t[0].spatialReference,h=r({},u,{query:r({},i.query,{f:"json",sr:JSON.stringify(c),target:JSON.stringify({geometryType:l.getJsonType(t[0]),geometries:t}),cutter:JSON.stringify(d)})}),[4,a(i.path+"/cut",h)];case 1:return p=n.sent(),f=p.data,g=f.cutIndexes,y=f.geometries,[2,{cutIndexes:g,geometries:(void 0===y?[]:y).map(function(e){return o.fromJSON(e).set(c)})}]}})})}}.apply(null,i))||(e.exports=n)},1475:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(7),r(13),r(11),r(48),r(31),r(71)],void 0===(n=function(e,t,r,i,n,o,a,s){Object.defineProperty(t,"__esModule",{value:!0}),t.simplify=function(e,t,l){return i(this,void 0,void 0,function(){var i,d,u,c;return n(this,function(n){switch(n.label){case 0:return i="string"==typeof e?a.urlToObject(e):e,d=t[0].spatialReference,u=s.getJsonType(t[0]),c=r({},l,{query:r({},i.query,{f:"json",sr:d.wkid?d.wkid:JSON.stringify(d),geometries:JSON.stringify(function(e){return{geometryType:s.getJsonType(e[0]),geometries:e.map(function(e){return e.toJSON()})}}(t))})}),[4,o(i.path+"/simplify",c)];case 1:return[2,function(e,t,r){var i=s.getGeometryType(t);return e.map(function(e){var t=i.fromJSON(e);return t.spatialReference=r,t})}(n.sent().data,u,d)]}})})}}.apply(null,i))||(e.exports=n)},1476:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(1),r(9),r(29),r(0),r(356),r(1471)],void 0===(n=function(e,t,r,i,n,o,a,s,l){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.slicePlaneEnabled=!1,t.supportsHeightUnitConversion=!1,t}return r(t,e),t.prototype.postscript=function(e){this.inherited(arguments),s.mayHaveHeightModelInfo(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())},t.prototype._validateHeightModelInfo=function(){var e=this;return n.create(function(t,r){o.whenFalseOnce(e.view.defaultsFromMap,"isHeightModelInfoSearching",function(){var i=s.rejectLayerError(e.layer,e.view.heightModelInfo,e.supportsHeightUnitConversion);i?r(i):t()})})},i([a.property()],t.prototype,"view",void 0),i([a.property()],t.prototype,"slicePlaneEnabled",void 0),i([a.subclass("esri.views.3d.layers.LayerView3D")],t)}(a.declared(l))}.apply(null,i))||(e.exports=n)},1482:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.updatingPercentageValue={value:100,readOnly:!0},t.updatingPercentage={dependsOn:["updating","updatingPercentageValue"],readOnly:!0,value:0,get:function(){return this.updating?this.updatingPercentageValue:0}}}.apply(null,i))||(e.exports=n)},1493:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(23),r(84),r(12),r(360),r(361),r(354)],void 0===(n=function(e,t,r,i,n,o,a,s){function l(e,t,i){var n="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(function(e){return"color"===e.type})[0]:e;if(n){if("esri.renderers.visualVariables.ColorVariable"!==n.declaredClass)return void y.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");var o="number"==typeof t,a=o?null:t,l=a&&a.attributes,d=o?t:null,u=n.field,c=n.cache,h=c.ipData,p=c.hasExpression,f=n.cache.compiledFunc;if(!u&&!p){var m=n.stops;return m&&m[0]&&m[0].color}if("number"!=typeof d)if(p){var v=i&&{viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},_=s.getViewInfo(v),b=s.createExecContext(a,_);if(!f){var x=s.createSyntaxTree(n.valueExpression);f=s.createFunction(x),n.cache.compiledFunc=f}d=s.executeFunction(f,b)}else l&&(d=l[u]);var w=n.normalizationField,C=l?parseFloat(l[w]):void 0;if(null!=d&&(!w||o||!isNaN(C)&&0!==C)){isNaN(C)||o||(d/=C);var S=g(d,h);if(S){var D=S[0],I=S[1],P=D===I?n.stops[D].color:r.blendColors(n.stops[D].color,n.stops[I].color,S[2],i&&i.color);return new r(P)}}}}function d(e,t,r){var i="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(function(e){return"opacity"===e.type})[0]:e;if(i){if("esri.renderers.visualVariables.OpacityVariable"!==i.declaredClass)return void y.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");var n="number"==typeof t,o=n?null:t,a=o&&o.attributes,l=n?t:null,d=i.field,u=i.cache,c=u.ipData,h=u.hasExpression,p=i.cache.compiledFunc;if(!d&&!h){var f=i.stops;return f&&f[0]&&f[0].opacity}if("number"!=typeof l)if(h){var m=r&&{viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},v=s.getViewInfo(m),_=s.createExecContext(o,v);if(!p){var b=s.createSyntaxTree(i.valueExpression);p=s.createFunction(b),i.cache.compiledFunc=p}l=s.executeFunction(p,_)}else a&&(l=a[d]);var x=i.normalizationField,w=a?parseFloat(a[x]):void 0;if(null!=l&&(!x||n||!isNaN(w)&&0!==w)){isNaN(w)||n||(l/=w);var C=g(l,c);if(C){var S=C[0],D=C[1];if(S===D)return i.stops[S].opacity;var I=i.stops[S].opacity;return I+(i.stops[D].opacity-I)*C[2]}}}}function u(e,t,r){var i="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(function(e){return"rotation"===e.type})[0]:e;if(i){if("esri.renderers.visualVariables.RotationVariable"!==i.declaredClass)return void y.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");var n=i.axis||"heading",o="heading"===n&&"arithmetic"===i.rotationType?90:0,a="heading"===n&&"arithmetic"===i.rotationType?-1:1,l="number"==typeof t?null:t,d=l&&l.attributes,u=i.field,c=i.cache.hasExpression,h=i.cache.compiledFunc,p=0;if(!u&&!c)return p;if(c){var f=r&&{viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},g=s.getViewInfo(f),m=s.createExecContext(l,g);if(!h){var v=s.createSyntaxTree(i.valueExpression);h=s.createFunction(v),i.cache.compiledFunc=h}p=s.executeFunction(h,m)}else d&&(p=d[u]||0);return"number"!=typeof p||isNaN(p)?null:o+a*p}}function c(e,t,r){var i="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(function(e){return"size"===e.type})[0]:e;if(i){if("esri.renderers.visualVariables.SizeVariable"!==i.declaredClass)return void y.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");var n=f(function(e,t,r){var i="number"==typeof t,n=i?null:t,o=n&&n.attributes,l=i?t:null,d=e.cache.isScaleDriven,u=e.cache.compiledFunc;if(d){var c=r&&r.scale,h=r&&r.view;l=null==c||h&&"3d"===h.type?function(e){var t=null,r=null,i=e.stops;return i?(t=i[0].value,r=i[i.length-1].value):(t=e.minDataValue||0,r=e.maxDataValue||0),(t+r)/2}(e):c}else if(!i)switch(e.inputValueType){case"expression":var p=r&&{viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},f=s.getViewInfo(p),g=s.createExecContext(n,f);if(!u){var y=s.createSyntaxTree(e.valueExpression);u=s.createFunction(y),e.cache.compiledFunc=u}l=s.executeFunction(u,g);break;case"field":o&&(l=o[e.field]);break;case"unknown":l=null}if(!a.isValidNumber(l))return null;if(i||!e.normalizationField)return l;var m=o?parseFloat(o[e.normalizationField]):null;return a.isValidNumber(m)&&0!==m?l/m:null}(i,t,r),i,t,r,i.cache.ipData);return null===n||void 0===n||isNaN(n)?0:n}}function h(e,t,r){return null==e?null:a.isSizeVariable(e)?c(e,t,r):a.isValidNumber(e)?e:null}function p(e,t,r){return a.isValidNumber(r)&&e>r?r:a.isValidNumber(t)&&e<t?t:e}function f(e,t,r,i,n){switch(t.transformationType){case"additive":return function(e,t,r,i){return e+(h(t.minSize,r,i)||t.minDataValue)}(e,t,r,i);case"constant":return function(e,t,r){var i=e.stops,n=i&&i.length&&i[0].size;return null==n&&(n=e.minSize),h(n,t,r)}(t,r,i);case"clamped-linear":return function(e,t,r,i){var n=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),o=h(t.minSize,r,i),a=h(t.maxSize,r,i),s=i&&i.shape;if(e<=t.minDataValue)return o;if(e>=t.maxDataValue)return a;if("area"===t.scaleBy&&s){var l="circle"===s,d=l?v*Math.pow(o/2,2):o*o,u=d+n*((l?v*Math.pow(a/2,2):a*a)-d);return l?2*Math.sqrt(u/v):Math.sqrt(u)}return o+n*(a-o)}(e,t,r,i);case"proportional":return function(e,t,r,i){var n=i&&i.shape,o=e/t.minDataValue,a=h(t.minSize,r,i),s=h(t.maxSize,r,i);return p("circle"===n?2*Math.sqrt(o*Math.pow(a/2,2)):"square"===n||"diamond"===n||"image"===n?Math.sqrt(o*Math.pow(a,2)):o*a,a,s)}(e,t,r,i);case"stops":return function(e,t,r,i,n){var o=g(e,n),a=o[0],s=o[1],l=o[2];if(a===s)return h(t.stops[a].size,r,i);var d=h(t.stops[a].size,r,i);return d+(h(t.stops[s].size,r,i)-d)*l}(e,t,r,i,n);case"real-world-size":return function(e,t,r,i){var n=(i&&i.resolution?i.resolution:1)*o.meterIn[t.valueUnit],a=h(t.minSize,r,i),s=h(t.maxSize,r,i),l=t.valueRepresentation;return p("area"===l?2*Math.sqrt(e/v)/n:"radius"===l||"distance"===l?2*e/n:e/n,a,s)}(e,t,r,i);case"identity":return function(e){return e}(e);case"unknown":return null}}function g(e,t){if(t){var r=0,i=t.length-1;return t.some(function(t,n){return e<t?(i=n,!0):(r=n,!1)}),[r,i,(e-t[r])/(t[i]-t[r])]}}Object.defineProperty(t,"__esModule",{value:!0});var y=n.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),m=new i,v=Math.PI;t.getColor=l,t.getOpacity=d,t.getRotationAngle=u,t.getSize=c,t.getSizeFromNumberOrVariable=h,t.getSizeForValue=f,t.getSizeRangeAtScale=function(e,t,r){var i=e.cache.isScaleDriven,n=r&&"3d"===r.type;if(!(i&&n||t))return null;var o={scale:t,view:r},a=h(e.minSize,m,o),s=h(e.maxSize,m,o);if(null!=a||null!=s){if(a>s){var l=s;s=a,a=l}return{minSize:a,maxSize:s}}},t.getVisualVariableValues=function(e,t,r){if(e.visualVariables){for(var i=[],n=[],o=[],a=[],s=[],h=0,p=e.visualVariables;h<p.length;h++){var f=p[h];switch(f.type){case"color":n.push(f);break;case"opacity":o.push(f);break;case"rotation":s.push(f);break;case"size":a.push(f)}}return n.forEach(function(e){var n=l(e,t,r);i.push({variable:e,value:n})}),o.forEach(function(e){var n=d(e,t,r);i.push({variable:e,value:n})}),s.forEach(function(e){var n=u(e,t,r);i.push({variable:e,value:n})}),a.forEach(function(e){var n=c(e,t,r);i.push({variable:e,value:n})}),i.filter(function(e){return null!=e.value})}}}.apply(null,i))||(e.exports=n)},1506:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(1),r(8),r(10),r(0),r(27)],void 0===(n=function(e,t,r,i,n,o,a,s){var l=function(e){function t(t){var r=e.call(this,t)||this;return r.attachmentTypes=null,r.globalIds=null,r.num=null,r.objectIds=null,r.returnMetadata=!1,r.size=null,r.start=null,r.where=null,r}var n;return r(t,e),n=t,t.prototype.writeStart=function(e,t,r){t.resultOffset=this.start,t.resultRecordCount=this.num||10},t.prototype.clone=function(){return new n(o.clone({attachmentTypes:this.attachmentTypes,where:this.where,globalIds:this.globalIds,num:this.num,objectIds:this.objectIds,returnMetadata:this.returnMetadata,size:this.size,start:this.start}))},i([a.property({type:[String],json:{write:!0}})],t.prototype,"attachmentTypes",void 0),i([a.property({type:[Number],json:{write:!0}})],t.prototype,"globalIds",void 0),i([a.property({type:Number,json:{read:{source:"resultRecordCount"}}})],t.prototype,"num",void 0),i([a.property({type:[Number],json:{write:!0}})],t.prototype,"objectIds",void 0),i([a.property({type:Boolean,json:{default:!1,write:!0}})],t.prototype,"returnMetadata",void 0),i([a.property({type:[Number],json:{write:!0}})],t.prototype,"size",void 0),i([a.property({type:Number,json:{read:{source:"resultOffset"}}})],t.prototype,"start",void 0),i([a.writer("start"),a.writer("num")],t.prototype,"writeStart",null),i([a.property({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],t.prototype,"where",void 0),n=i([a.subclass("esri.tasks.support.AttachmentQuery")],t)}(a.declared(n));return l.from=s.default(l),l}.apply(null,i))||(e.exports=n)},1511:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(1),r(42),r(8),r(10),r(0),r(27)],void 0===(n=function(e,t,r,i,n,o,a,s,l){var d=function(e){function t(t){var r=e.call(this,t)||this;return r.gdbVersion=null,r.geometryPrecision=void 0,r.historicMoment=null,r.maxAllowableOffset=void 0,r.objectIds=null,r.outFields=null,r.outSpatialReference=null,r.relationshipId=void 0,r.returnGeometry=!1,r.source=null,r.where=null,r}var o;return r(t,e),o=t,t.prototype._writeHistoricMoment=function(e,t){t.historicMoment=e&&e.getTime()},t.prototype.clone=function(){return new o(a.clone({gdbVersion:this.gdbVersion,geometryPrecision:this.geometryPrecision,historicMoment:this.historicMoment&&this.historicMoment.getTime(),maxAllowableOffset:this.maxAllowableOffset,objectIds:this.objectIds,outFields:this.outFields,outSpatialReference:this.outSpatialReference,relationshipId:this.relationshipId,returnGeometry:this.returnGeometry,source:this.source,where:this.where}))},i([s.property({type:String,json:{write:!0}})],t.prototype,"gdbVersion",void 0),i([s.property({type:Number,json:{write:!0}})],t.prototype,"geometryPrecision",void 0),i([s.property({type:Date})],t.prototype,"historicMoment",void 0),i([s.writer("historicMoment")],t.prototype,"_writeHistoricMoment",null),i([s.property({type:Number,json:{write:!0}})],t.prototype,"maxAllowableOffset",void 0),i([s.property({type:[Number],json:{write:!0}})],t.prototype,"objectIds",void 0),i([s.property({type:[String],json:{write:!0}})],t.prototype,"outFields",void 0),i([s.property({type:n.SpatialReference,json:{read:{source:"outSR"},write:{target:"outSR"}}})],t.prototype,"outSpatialReference",void 0),i([s.property({json:{write:!0}})],t.prototype,"relationshipId",void 0),i([s.property({json:{write:!0}})],t.prototype,"returnGeometry",void 0),i([s.property({json:{write:!0}})],t.prototype,"source",void 0),i([s.property({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],t.prototype,"where",void 0),o=i([s.subclass("esri.tasks.support.RelationshipQuery")],t)}(s.declared(o));return d.from=l.default(d),d}.apply(null,i))||(e.exports=n)},1518:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.attributeLookup=function(e,t){for(var r=t.toLowerCase(),i=0,n=Object.keys(e);i<n.length;i++){var o=n[i];if(o.toLowerCase()===r)return e[o]}return null}}.apply(null,i))||(e.exports=n)},1529:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){return function(){function e(){this.items=[]}return e.prototype.addObject=function(e,t){this.items.push({type:"object",highlightId:t,object:e})},e.prototype.addRenderGeometry=function(e,t,r){this.items.push({type:"renderGeometry",highlightId:t,renderGeometry:e,owner:r})},e.prototype.addExternal=function(e,t){this.items.push({type:"external",highlightId:t,remove:e})},e.prototype.remove=function(e){for(var t=this.items.length-1;t>=0;--t){var r=this.items[t];r.highlightId===e&&(this.removeHighlight(r),this.items.splice(t,1))}},e.prototype.removeObject=function(e){for(var t=this.items.length-1;t>=0;--t){var r=this.items[t];"object"===r.type&&r.object===e&&(this.removeHighlight(r),this.items.splice(t,1))}},e.prototype.removeRenderGeometry=function(e){for(var t=this.items.length-1;t>=0;--t){var r=this.items[t];"renderGeometry"===r.type&&r.renderGeometry===e&&(this.removeHighlight(r),this.items.splice(t,1))}},e.prototype.removeAll=function(){var e=this;this.items.forEach(function(t){e.removeHighlight(t)}),this.items=[]},e.prototype.removeHighlight=function(e){switch(e.type){case"object":e.object.removeHighlights(e.highlightId);break;case"renderGeometry":e.owner.removeRenderGeometryHighlight(e.renderGeometry,e.highlightId);break;case"external":e.remove(e.highlightId)}},e}()}.apply(null,i))||(e.exports=n)},1531:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(9)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this._deferreds=[],this._values=[]}return e.prototype.push=function(e){var t=this;return r.create(function(r,i){t._deferreds.push({resolve:r,reject:i}),t._values.push(e)})},e.prototype.unshift=function(e){var t=this;return r.create(function(r,i){t._deferreds.unshift({resolve:r,reject:i}),t._values.unshift(e)})},Object.defineProperty(e.prototype,"length",{get:function(){return this._deferreds.length},enumerable:!0,configurable:!0}),e.prototype.process=function(){return 0!==this.length&&(this._deferreds.shift().resolve(this._values.shift()),!0)},e.prototype.cancelAll=function(){for(var e=r.createAbortError(),t=0,i=this._deferreds;t<i.length;t++)i[t].reject(e);this._deferreds.length=0,this._values.length=0},e}();t.PromiseQueue=i}.apply(null,i))||(e.exports=n)},1545:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(7),r(588)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0}),t.isUniformComponentData=function(e){return!(e instanceof i.TextureBackedBuffer)},t.fillDefaults=function(e){return r({baseColor:n,baseColorOpacity:1,baseColorTexture:null,doubleSidedShading:!1,normals:"screen-space",cullFace:"back",componentData:o,receiveSSAO:!0,forceTransparency:null,slicePlaneEnabled:!1,polygonOffsetEnabled:!1,writeStencil:!1,readStencil:!1,layerOpacity:1},e)};var n=[1,1,1],o={externalColor:[1,1,1,1],externalColorMixMode:"multiply",castShadows:!0}}.apply(null,i))||(e.exports=n)},1546:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(68)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.createVertexBufferLayout=function(e){var t=r.newLayout().vec3f("position");return"compressed"===e.normals?t.vec2i16("normalCompressed",{glNormalized:!0}):"default"===e.normals&&t.vec3f("normal"),e.textureCoordinates&&t.vec2f("uv0"),e.textureCoordinateRegions&&t.vec4u16("region",{glNormalized:!0}),e.colors&&t.vec4u8("color"),e.componentData&&t.u16("componentIndex"),t.alignTo(4)}}.apply(null,i))||(e.exports=n)},1564:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(1),r(6),r(45),r(52),r(37),r(20),r(22),r(12),r(86),r(201),r(9),r(29),r(0),r(4),r(3),r(43),r(35),r(95),r(1531),r(1565),r(1566),r(1567),r(1568),r(1569),r(1477),r(1570),r(209),r(38),r(565)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h,p,f,g,y,m,v,_,b,x,w,C,S,D,I,P,M,N,O,V){function T(e,t){return e.length===t.length&&e.every(function(e){return L(t,e.name)>=0})}function L(e,t){for(var r=t.toLowerCase(),i=0;i<e.length;i++)if(e[i].name.toLowerCase()===r)return i;return-1}function E(e){return null!=e&&null!=e.loadedAttributes&&null!=e.attributeData}var R=u.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),A=function(e){function t(t){var r=e.call(this,t)||this;return r.screenSizeFactor=0,r.featureTarget=5e4,r.fixedFeatureTarget=!1,r.updating=!0,r.updatingPercentage=0,r.leafsReached=!1,r.scaleVisibilityEnabled=!0,r.uncompressedTextureDownsamplingEnabled=!1,r._featureLOD=1,r._stableFeatureLOD=!1,r._isIdle=!1,r._cameraDirty=!0,r._invisibleDirty=!1,r._newLoadingNodes=new c({deallocator:null}),r._loadedNodeScales=new Map,r._abortController=p.createAbortController(),r._downloadingNodes=new Set,r._loadingNodes=new Set,r._updatingNodes=new Set,r._progressMaxNumNodes=1,r._poi=m.vec3f64.create(),r._requiredAttributesDirty=!0,r._updatesDisabled=!1,r.disableIDBCache=!1,r.disableMemCache=!1,r._restartNodeLoading=!1,r._fields=null,r._attributeStorageInfo=null,r._handles=new l,r._idleQueue=new x.PromiseQueue,r._errorCount=0,r}return r(t,e),Object.defineProperty(t.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isGraphics3D",{get:function(){return"points"===this.layer.profile},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"streamDataController",{get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(N.ClientType.SCENE);return new I.default(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsVertex",{get:function(){return P.getVertexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsIndex",{get:function(){return P.getIndexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rootNodeVisible",{get:function(){var e=this._index&&this._index.rootNode;return!e||(this._updateViewData(),this._index.isNodeVisible(e.index))},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._lodHandling=new S(this.layerView,function(){return e._evaluateUpdating()});var t=this.layerView.layer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=d("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo);var r=p.all([this.layer.when(),this.layerView.when()]).then(function(){if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var r=e.layerView.view;e._setClippingArea(r.clippingArea),e._centerOnSurface=r.pointsOfInterest.centerOnSurfaceFrequent;var i=e.layerView.view.resourceController;e._handles.add([e._centerOnSurface.watch("renderLocation",function(){return e._pointOfInterestChanged()}),i.memoryController.events.on("quality-changed",function(){return e._setCameraDirty()}),f.init(e.layerView,"suspended",function(t){var r=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},n=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=r,e._idleStateCallbacks.idleEnd=n):e._idleStateCallbacks=i.scheduler.registerIdleStateCallbacks(r,n)}),w.addTask(e.layerView.view.resourceController.scheduler,{update:function(t,r){return e._frame(t,r)},needsUpdate:function(){return e.updating}}),e.watch("uncompressedTextureDownsamplingEnabled",function(){return e.restartNodeLoading()}),e.watch(["featureTarget","fixedFeatureTarget"],function(){e._setCameraDirty(),e._stableFeatureLOD=!1}),r.state.watch("camera",function(){return e._setCameraDirty()}),e.layer.watch("elevationInfo",function(){return e._elevationInfoChanged()}),e.layer.watch(["minScale","maxScale"],function(){return e._scaleBoundsChanged()}),e.layerView.watch("lodFactor",function(){return e._setCameraDirty()}),e.layerView.watch("availableFields?",function(){return e._requiredFieldsChange()})]),e._updateScaleHandles(),e._viewportQueries=new M(e.crsIndex,r.renderCoordsHelper,r.state.camera,e._clippingArea,r.elevationProvider,e.layer,{progressiveLoadFactor:e._getProgressiveLoadFactor(e.layer),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5});var n=t.store.rootNode.split("/").pop();e._index=new C.I3SIndex(e.getBaseUrl(),n,e.layer.nodePages,e.streamDataController,e._viewportQueries,R,function(t){return e.layerView.isNodeLoaded(t)},function(t){return e._shouldLoadNode(t)},function(t){return e._enableFromGPUCache(t,"leaf")},function(t){return e._needsUpdate(t)})}});this._tmpPoint=b.makeDehydratedPoint(0,0,0,this.crsIndex),this.addResolvingPromise(r),this.when(function(){return e._startNodeLoading()})},t.prototype.destroy=function(){this._abortController.abort(),this._abortController=null,this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,j.prune()},t.prototype._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,r=this.layer.objectIdField;return this.layerView.availableFields.map(function(r){var i=L(e,r),n=L(t,r);return i>=0&&n>=0?{index:i,name:t[n].name,field:t[n],attributeStorageInfo:e[i]}:null}).filter(function(e){return null!=e&&e.name!==r})},t.prototype._requiredFieldsChange=function(){T(this._requiredAttributes,this._getRequiredAttributes())||this.requestUpdate()},t.prototype.requestUpdate=function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()},t.prototype._setClippingArea=function(e){var t=v.create();O.extentToBoundingBox(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null},t.prototype._pointOfInterestChanged=function(){this._poi&&(this._calculatePointOfInterest(this._poi),this._viewportQueries&&(this._viewportQueries.setPointOfInterest(this._poi),this._index&&(this._index.progressiveLoadPenalty=F.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate())))},t.prototype._calculatePointOfInterest=function(e){var t=this._centerOnSurface.renderLocation,r=m.vec3f64.create();y.vec3.subtract(r,t,this.camPos);var i=this.layerView.view.renderCoordsHelper,n=m.vec3f64.create();i.worldUpAtPosition(t,n);var o=y.vec3.angle(n,r)-.5*Math.PI;return y.vec3.lerp(e,this.camPos,t,Math.max(0,Math.min(1,o/(.5*Math.PI)))),e},t.prototype.updateClippingArea=function(e){this._setClippingArea(e),this._viewportQueries&&this._index&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()},t.prototype._setCameraDirty=function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._evaluateUpdating()},t.prototype.getBaseUrl=function(){return this.layer.parsedUrl.path},t.prototype.updateElevationChanged=function(e,t){if(null!=this._index){null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new c({deallocator:null}));var r=this._elevationUpdateNodes;r.clear();var i=this._index.rootNode;null!=i&&P.findIntersectingNodes(e,t,i,this.crsIndex,this._index,function(e){return r.push(e.index)});for(var n=0;n<r.length;n++){var o=r.data[n];this._index.invalidateBoundingVolumeCache(o),o===i.index&&this.notifyChange("rootNodeVisible")}r.length&&this.restartNodeLoading()}},t.prototype.getParentIndex=function(e){return this._index.getParentIndex(e)},t.prototype._elevationInfoChanged=function(){this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()},t.prototype._updateScaleHandles=function(){var e=this;this._handles.remove("scale-bounds"),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",function(t){return e._scaleUpdateHandler(t)}),"scale-bounds")},t.prototype._scaleBoundsChanged=function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty(),this._lodHandling.setLodGlobalDirty()},t.prototype._scaleUpdateHandler=function(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty(),this._lodHandling.setLodGlobalDirty()},t.prototype._updateScaleInBoundingRect=function(e,t,r){var i=this;null!=this._index.rootNode&&O.boundingRectToBoundingRect(t,r,G,this.crsIndex)&&this._loadedNodeScales.forEach(function(t,r){var n=i._index.getNode(r);_.containsPoint(G,n.mbs)&&i._loadedNodeScales.set(r,e)})},t.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0,this._evaluateUpdating()},t.prototype.schedule=function(e,t){var r=this;return this._idleQueue.push(t).then(function(t){if(!r._loadingNodes.has(e)&&!r._updatingNodes.has(e))throw p.createAbortError();return t})},t.prototype.reschedule=function(e,t){var r=this;return this._idleQueue.unshift(t).then(function(t){if(!r._loadingNodes.has(e)&&!r._updatingNodes.has(e))throw p.createAbortError();return t})},Object.defineProperty(t.prototype,"isIntegratedMesh",{get:function(){return"integrated-mesh"===this.layer.type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"areScaleBoundsActive",{get:function(){var e=V.extractSafeScaleBounds(this.layer),t=e.minScale,r=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||r>0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"unloadedMemoryEstimate",{get:function(){return!this._index||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"indexDepth",{get:function(){return this._index?this._index.maxLevel:0},enumerable:!0,configurable:!0}),t.prototype._frame=function(e,t){return this.layerView.suspended?(this._updateView(e),-1/0):this.layerView.visible?(this._processLogError(e,t),this._index.getPriority()):-1/0},t.prototype._processLogError=function(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?R.error("Error during processing: "+e):50===this._errorCount&&R.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}},t.prototype._process=function(e,t){var r=this;if(this._restartNodeLoading&&(this.cancelNodeLoading(),this._startNodeLoading()),null!=this._nodeLoader&&null!=this._index){for(this._updateView(e),this.isIntegratedMesh&&(e.enabled=!1),e.run(function(){return r._processIndex(t,e)}),this._updateFeatureLOD(),e.run(function(){return r._processCache(e,t)}),this.isIntegratedMesh&&(e.enabled=!0),e.run(function(){return r._processNodes(e,t)});!e.done&&this._idleQueue.process();)e.madeProgress();e.run(function(){return r._prefetchIndex(t)}),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingNodes.size,this._evaluateUpdating(),this._lodHandling.lodGlobalHandling(e)}},t.prototype._processIndex=function(e,t){if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(o.keysOfSet(this._loadingNodes),t),!this.disableMemCache&&this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData&&(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var r=this._index.getFeatureEstimate().leafsReached;this._index.isLoading()||r===this._get("leafsReached")||this._set("leafsReached",r)}var i=Math.min(10-e.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,e));return this._index.load(i)},t.prototype._prefetchIndex=function(e){if(this._loadingNodes.size>0||this._index.updates.add.length>0)return!1;var t=Math.min(10-e.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,e));return this._index.prefetch(t)},t.prototype._updateFeatureLOD=function(){if(this.isGraphics3D){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,r=this._index.getFeatureEstimate();if(r.estimate=r.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=1e-4)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&r.estimate<t){if(r.leafsReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var i=Math.min(10,Math.max(t/r.estimate,1.001));this._featureLOD*=i;var n=this.lod,o=this._index.checkFeatureTarget(t,n);o!==n&&(this._featureLOD=o/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(r.estimate>1.2*t||e&&r.estimate>t))return;if(this._featureLOD<=1e-4)return;this._featureLOD/=1+.25*(r.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(1e-4,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}},t.prototype._processCache=function(e,t){for(;this._newLoadingNodes.length>0&&!e.done;)for(var r=this._newLoadingNodes.pop(),i=this._index.getParent(r);i&&!this.layerView.isNodeLoaded(i.index)&&this._isNodeInScaleBounds(i);i=this._index.getParent(i.index))if(this._enableFromGPUCache(i,"hole")){e.madeProgress();break}return e.hasProgressed},t.prototype._processNodes=function(e,t){var r=(this._isIdle?100:2)-this._loadingNodes.size,i=this._index.updates;for(i.cancel.forEach(this._cancelNode,this),i.cancel=[];i.update.length>0&&!e.done;){var n=this._index.getNode(i.update.pop());this._updateLoadedNode(n),e.madeProgress()}for(;i.add.length>0&&!e.done&&r>0;){if(--r,2!==(n=this._index.getNode(i.add.back())).cacheState&&!this._hasNodeLoadToken(t))break;i.add.pop(),this._loadNode(n),e.madeProgress()}return e.hasProgressed},t.prototype._cancelAllNodes=function(){this._loadingNodes.clear(),this._downloadingNodes.clear(),this._updatingNodes.clear(),this._abortController.abort(),this._abortController=new AbortController},t.prototype._cancelNode=function(e){this._loadingNodes.delete(e),this._downloadingNodes.delete(e)},t.prototype._getAvailableLoadTokens=function(e,t){var r=t.numIndexLoading+this._index.getIndexLoading(),i=t.numNodesLoading+this._loadingNodes.size;return Math.floor((12-1*r-2*i)/e)},t.prototype._hasNodeLoadToken=function(e){var t=this._isIdle&&!this._index.isLoading()?5:2;return!(e.numNodesLoading+this._loadingNodes.size>=t)&&this._getAvailableLoadTokens(2,e)>0},t.prototype._evaluateUpdating=function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._invisibleDirty||this._cameraDirty)?100:0;else{var r=(this._index?this._index.getIndexMissing():0)+3*(this._index?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(r>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===r&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(r,this._progressMaxNumNodes),t=100*r/this._progressMaxNumNodes}e!==this._get("updating")&&this._set("updating",e),t!==this._get("updatingPercentage")&&this._set("updatingPercentage",t)},t.prototype._updateView=function(e){this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this._evaluateUpdating()},t.prototype._updateViewData=function(){if(this._cameraDirty&&this._index){var e=this.layerView.view,t=e.state.camera;this.camPos=m.vec3f64.clone(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._poi=this._calculatePointOfInterest(this._poi),this._viewportQueries.updateCamera(t),this._viewportQueries.setPointOfInterest(this._poi),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=F.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}},t.prototype._getProgressiveLoadFactor=function(e){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor},Object.defineProperty(t.prototype,"lod",{get:function(){return this._featureLOD*this.baseLOD},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"baseLOD",{get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lodDropFactor",{get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)},enumerable:!0,configurable:!0}),t.prototype.isGeometryVisible=function(e){return this._index.isGeometryVisible(e.index)},t.prototype.updateVisibility=function(e){return this._index.invalidateVisibilityCache(e)},t.prototype._shouldLoadNode=function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&(!e.obb||this._index.isGeometryVisible(e.index))},t.prototype._shouldDropNode=function(e){var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.childrenEmpty(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t},t.prototype._startNodeLoading=function(){var e=this;if(this._restartNodeLoading=!1,!this._updatesDisabled&&null!=this.streamDataController){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var t=D.TextureFormat.Normal;this.layerView.useCompressedTextures?t=D.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(t=D.TextureFormat.Downsampled);var r={textureFormat:t,loadTextureData:this.layerView.rendererNeedsTextures,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new D(this.layer,this.streamDataController,R,this._defaultGeometrySchema,this._requiredAttributes,r);var i=this.layerView.view.renderSpatialReference,n=this.crsIndex.equals(i)||this.crsIndex.isWGS84&&i.equals(O.SphericalECEFSpatialReference);this._index.ignoreServiceOBB=!n,this._index.requestUpdate(),this._lodHandling.startNodeLoading(function(t){return e._index.isNodeVisible(t)},function(t){return e._index.isGeometryVisible(t)},function(t){return e._isNodeInScaleBounds(t)},function(t){return e._index.nodeTraversalState(t)},function(t,r){return e._removeNodes(t,r)},this._index,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}},t.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index},t.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this.streamDataController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this.layerView.additionalCancelNodeLoadingHandler&&this.layerView.additionalCancelNodeLoadingHandler(),this._evaluateUpdating())},t.prototype._removeInvisibleNodes=function(e){var t=this;j.clear(),this.layerView.getLoadedNodeIndices(j);var r=0===this._viewportQueries.maxDistance,i=r?function(){return!1}:function(e){return t._shouldDropNode(e)};return j.filterInPlace(function(e){var r=t._index.getNode(e);return!t._index.isGeometryVisible(e)||i(r)||!t._isNodeInScaleBounds(r)}),j.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(j,e),!(r&&this.lodDropFactor<1||0!==j.length&&(j.clear(),1))},t.prototype._removeNodes=function(e,t){e.length>0&&this._index.requestUpdate();var r=e.length;if(this.layerView.removeNodeData(e,t),this._loadedNodeScales.size>0)for(var i=e.length;i<r;i++){var n=e.data[i];this._loadedNodeScales.delete(n)}},t.prototype._needsUpdate=function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes},t.prototype._updateLoadedNode=function(e){var t=this,r=T(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?p.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,this._abortController.signal);this._updatingNodes.add(e.index),r.then(function(r){return t.schedule(e.index).then(function(){return t.layerView.setAttributeData(e.index,{loadedAttributes:t._requiredAttributes,attributeData:r})})}).catch(function(r){p.isAbortError(r)||t.layerView.setAttributeData(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}})}).catch(function(){}).then(function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()}),this._evaluateUpdating()},t.prototype._loadNode=function(e){var t=this;this._loadingNodes.add(e.index),this._evaluateUpdating(),this._loadAndAddNode(e).catch(function(e){return e}).then(function(){t._loadingNodes.delete(e.index),t._evaluateUpdating()})},t.prototype._loadAndAddNode=function(e){var t=this;return 1===e.cacheState?this._loadUncached(e):this._loadCached(e).then(function(r){r||(e.cacheState=1,t._index.updates.add.push(e.index))}).catch(function(t){p.isAbortError(t)||(e.cacheState=1)})},t.prototype._enableFromGPUCache=function(e,t){if(this.disableMemCache||!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData)return!1;var r=this._loadCachedGPUData(e);return!!r&&(this.layerView.addCachedGPUData(e,r,t),this._nodeAdded(e),!0)},t.prototype._loadCachedGPUData=function(e){var t=this.layerView.loadCachedGPUData(e);return t&&E(t.attributeInfo)&&T(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:null},t.prototype._nodeAdded=function(e){this._index.requestUpdate(),this._lodHandling.lodSwapNodeLoaded(e)},t.prototype._loadCached=function(e){var t=this;if(this._enableFromGPUCache(e,"leaf"))return p.resolve(!0);var r=this.layerView;return!this.disableIDBCache&&r.loadCachedNodeData&&r.addCachedNodeData?this.schedule(e.index).then(function(){return r.loadCachedNodeData(e,function(r){return t._nodeLoader.loadTextures(e,r,t._abortController.signal)})}).then(function(i){if(null==i)return!1;var n=t._requiredAttributes;return E(i)&&T(i.loadedAttributes,n)?t.reschedule(e.index).then(function(){return r.addCachedNodeData(e,i,i)}).then(function(){return t._nodeAdded(e),!0}):t.reschedule(e.index).then(function(){return t._nodeLoader.loadAttributes(e,n,t._abortController.signal)}).then(function(r){return t.reschedule(e.index,{loadedAttributes:n,attributeData:r})}).then(function(t){return r.addCachedNodeData(e,i,t)}).then(function(){return t._nodeAdded(e),!0})}):p.resolve(!1)},t.prototype._loadUncached=function(e){var t=this;return this._downloadingNodes.add(e.index),a.safeCast(this._nodeLoader.loadNodeData(e,this._abortController.signal)).then(function(r){return t._downloadingNodes.delete(e.index),t.schedule(e.index,r)}).then(function(r){return t.layerView.addNodeData(e,r)}).then(function(){t._nodeAdded(e),e.cacheState=2}).catch(function(r){p.isAbortError(r)||(R.error("Failed to load node '"+e.id+"': "+r),e.failed=!0,t._index.requestUpdate())})},t.prototype._updateIdleState=function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&this._index.resetFailedNodes())},t.prototype._getScale=function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);var t=e.mbs;this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2];var r=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,r),r},t.prototype._isNodeInScaleBounds=function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),r=V.extractSafeScaleBounds(this.layer),i=r.minScale,n=r.maxScale;return V.scaleBoundsPredicate(t,i,n)},t.prototype.updateStats=function(e){e.index=this._index?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),this._index&&this._index.updateStats(e)},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceOBB(t){e._index.ignoreServiceOBB=t}}},enumerable:!0,configurable:!0}),i([g.property({readOnly:!0})],t.prototype,"isMeshPyramid",null),i([g.property({readOnly:!0})],t.prototype,"isGraphics3D",null),i([g.property({readOnly:!0})],t.prototype,"streamDataController",null),i([g.property({readOnly:!0})],t.prototype,"crsVertex",null),i([g.property({readOnly:!0})],t.prototype,"crsIndex",null),i([g.property()],t.prototype,"camPos",void 0),i([g.property()],t.prototype,"screenSizeFactor",void 0),i([g.property()],t.prototype,"featureTarget",void 0),i([g.property()],t.prototype,"fixedFeatureTarget",void 0),i([g.property()],t.prototype,"layerView",void 0),i([g.property()],t.prototype,"layer",void 0),i([g.property({readOnly:!0})],t.prototype,"updating",void 0),i([g.property({readOnly:!0})],t.prototype,"updatingPercentage",void 0),i([g.property({readOnly:!0})],t.prototype,"leafsReached",void 0),i([g.property({constructOnly:!0})],t.prototype,"scaleVisibilityEnabled",void 0),i([g.property({readOnly:!0})],t.prototype,"rootNodeVisible",null),i([g.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled?"})],t.prototype,"uncompressedTextureDownsamplingEnabled",void 0),i([g.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],t)}(g.declared(n,h,s)),j=new c({deallocator:null}),F={factorIM:.2,factor3dObject:.05,distancePenalty:10},G=_.create();return A}.apply(null,i))||(e.exports=n)},1565:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(45)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){var t=this;this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=e.registerTask(2,function(e){return t.update(e)},function(){return t.needsUpdate()})}return e.prototype.destroy=function(){this.handle&&(this.handle.remove(),this.handle=null)},e.prototype.needsUpdate=function(){for(var e=0,t=this.callbacks;e<t.length;e++)if(t[e].needsUpdate())return!0;return!1},e.prototype.update=function(e){this.sort();for(var t=this.callbacks,r={numIndexLoading:0,numNodesLoading:0},i=0;i<t.length&&!e.done;++i)t[i].priority=t[i].update(e,r),this.runIndex=i},e.prototype.sort=function(){for(var e=this.callbacks,t=e.length,r=this.runIndex;r>0;r--){for(var i=e[r-1],n=r;n<e.length&&i.priority<=e[n].priority&&(n!==t||i.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=i,t=n-1}this.runIndex=0},e.prototype.add=function(e){this.sort(),e.priority=1/0,this.callbacks.unshift(e)},e.prototype.remove=function(e){r.removeUnordered(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()},e}(),n=new Map;t.addTask=function(e,t){var r=n.get(e);return null==r&&(r=new i(e),n.set(e,r)),r.add(t),{remove:function(){if(null!=r){if(r.remove(t),r.callbacks.length>0)return void(r=null);n.delete(e),r.destroy(),r=null}}}}}.apply(null,i))||(e.exports=n)},1566:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(7),r(14),r(86),r(9),r(4),r(33),r(1477),r(1489)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d){function u(e){e.node?(e.node.renderMbs[3]=-1,e.node.renderObb.halfSize[0]=-1):e.ref&&(e.ref.renderMbs[3]=-1,e.ref.renderObb.halfSize[0]=-1)}function c(e){return l.addWraparound(e,-2)}function h(e){return l.addWraparound(e,2)}function p(e,t){return 0===t?0:e/t|0}function f(e,t){return 0===t?e:e%t}function g(e){if(e)for(var t=0;t<e.length;t++)for(var r=0,i=b;r<i.length;r++){var n=i[r];if(n[0]===e[t].metricType)return{lodMetric:n[1],maxError:e[t].maxError}}return{lodMetric:0,maxError:0}}function y(e){return Math.sqrt(e*(4/Math.PI))}Object.defineProperty(t,"__esModule",{value:!0});var m=function(){function e(e,t,r,i,o,a,s,l,d,u){var c=this;this.layerUrl=e,this.streamDataController=i,this.viewportQueries=o,this.logger=a,this._isLoaded=s,this._isSelected=l,this._enable=d,this._needsUpdate=u,this._dirty=!0,this.nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=function(e){return e},this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState={},this._version=0,this._visibilityCacheGeneration=h(0),this._maxLevel=1,this._featureEstimate={estimate:0,leafsReached:!1},this._unloadedMemoryEstimate=0,this._missing=new n({deallocator:null}),this._prefetch=new n({deallocator:null}),this._updates=new _,this.ignoreServiceOBB=!1,this.progressiveLoadPenalty=0,this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.initNodePages(r).catch(function(){return c.initNodeDocuments(t)})}return e.prototype.initNodePages=function(e){if(!e)return o.reject();switch(this.nodesPerPage=e.nodesPerPage,this.rootIndex=e.rootIndex,e.lodSelectionMetricType){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=y}var t=p(this.rootIndex,this.nodesPerPage);return this.loadPage(t)},e.prototype.initNodeDocuments=function(e){this.nodesPerPage=0,this.rootIndex=0,this.nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode({id:e,mbs:null},-1)},e.prototype.loadPage=function(e){var t=this;this._loading.add(e);var r=this.layerUrl+"/nodepages/"+e;return this.streamDataController.request(r,"json").then(function(r){t._loading.delete(e),t.addPage(e,r)}).catch(function(r){return t._loading.delete(e),t._failedPages.add(e),o.reject(r)})},e.prototype.addPage=function(e,t){for(var r=this,i=this.nodePages.length;i<e;i++)this.nodePages[i]=null;var n=[],o=[],l=t.nodes.map(function(t,i){var l=n.length,u=t.children?t.children.length:0;o.push(-1);for(var h=0;h<u;h++)n.push(t.children[h]);var p=""+t.index,f=d.clone(t.obb),g=s.vec4f64.fromArray([f.center[0],f.center[1],f.center[2],a.vec3.length(f.halfSize)]),y=t.mesh&&t.mesh.attribute,m=t.mesh&&t.mesh.geometry,v=t.mesh&&t.mesh.material,_={hasSharedResource:!1,hasFeatureData:!!m,attributes:y&&null!=y.resource?""+y.resource:null,geometry:m&&null!=m.resource?""+m.resource:null,texture:v&&null!=v.resource&&v.texelCountHint>0?""+v.resource:null,geometryDefinition:m?m.definition:-1,materialDefinition:v?v.definition:-1},b={id:p,index:e*r.nodesPerPage+i,childCount:u,failed:!1,cacheState:0,obb:f,mbs:g,level:0,resources:_,lodMetric:r.lodMetric,maxError:r.lodConversion(t.lodThreshold),renderMbs:s.vec4f64.fromArray([0,0,0,-1]),renderObb:d.create([0,0,0],[-1,-1,-1],[0,0,0,1]),numFeatures:m?m.featureCount:null,vertexCount:m?m.vertexCount:null};return{childOffset:l,childCount:u,visibilityCache:c(r._visibilityCacheGeneration),ref:null,node:b}});this.nodePages[e]={nodes:l,children:n,parents:o},this.nodeCount+=l.length,this.updateParentsAndLevel()},e.prototype.updateParentsAndLevel=function(){var e=this,t=[],r=function(r,n,o){var a=e.getPage(r);if(i.isSome(a)){var s=f(r,e.nodesPerPage);a.parents[s]=n;var l=a.nodes[s].node;l&&(l.level=o,t.push(r))}};for(r(this.rootIndex,-1,0);t.length;)for(var n=t.pop(),o=this.getNode(n),a=0;a<o.childCount;a++){r(this.getChildIndex(o,a),n,o.level+1)}},e.prototype.getPage=function(e){return this.nodePages[p(e,this.nodesPerPage)]},e.prototype.getNodeInternal=function(e){var t=this.getPage(e);return i.isNone(t)?null:t.nodes[f(e,this.nodesPerPage)]},e.prototype.addNode=function(e,t){null!=e.children&&this.populateChildren(t,e.children);var r=this.getParent(t),n=r?r.level+1:1;this._maxLevel=Math.max(this._maxLevel,n);var o=g(e.lodSelection),a=o.lodMetric,l=o.maxError,u=i.expect(this.getNodeInternal(t));return u.node={id:e.id,index:t,mbs:s.vec4f64.fromArray(e.mbs),obb:e.obb&&d.clone(e.obb),childCount:u.childCount,level:n,resources:e.resources,version:e.version,lodMetric:a,maxError:l,memory:null,numFeatures:e.numFeatures,failed:!1,cacheState:0},null==u.ref.mbs&&(u.ref.mbs=e.mbs),u.node.renderMbs=u.ref.renderMbs,u.node.renderObb=u.ref.renderObb,u.node},e.prototype.makeRefNode=function(e,t){var r=this.nodePages[0],i=r.nodes.length;return r.nodes.push({childOffset:0,childCount:0,node:null,ref:e,visibilityCache:c(this._visibilityCacheGeneration)}),this.nodeCount++,r.parents.push(t),e.renderMbs=s.vec4f64.fromArray([0,0,0,-1]),e.renderObb=d.create([0,0,0],[-1,-1,-1],[0,0,0,1]),i},e.prototype.populateChildren=function(e,t){var r=i.expect(this.getNodeInternal(e)),n=i.expect(this.getPage(e));r.childOffset=n.children.length,r.childCount=t.length;for(var o=0;o<t.length;o++){var a=this.makeRefNode(t[o],e);n.children.push(a)}},e.prototype.getNode=function(e){var t=this.getNodeInternal(e);return i.isSome(t)&&t.node},e.prototype.getIndexById=function(e){var t;return this.forAllNodes(function(r,i){(r.node?r.node.id:r.ref.id)===e&&(t=i)}),t},e.prototype.getNodeById=function(e){var t=this.getIndexById(e),r=null!=t?this.getNodeInternal(t):null;return i.isSome(r)?r.node:null},e.prototype.getChildIndex=function(e,t){var r=this.getPage(e.index);if(i.isNone(r))return-1;var n=r.nodes[f(e.index,this.nodesPerPage)];return r.children[n.childOffset+t]},e.prototype.getParentIndex=function(e){var t=this.getPage(e);return i.isSome(t)?t.parents[f(e,this.nodesPerPage)]:-1},e.prototype.getParent=function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null},Object.defineProperty(e.prototype,"rootNode",{get:function(){var e=this.getNodeInternal(this.rootIndex);return i.isSome(e)?e.node:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this.nodeCount},enumerable:!0,configurable:!0}),e.prototype.invalidateVisibilityCache=function(e){if(null!=e){var t=this.getNodeInternal(e);i.isSome(t)&&(t.visibilityCache=c(this._visibilityCacheGeneration))}else this._visibilityCacheGeneration=h(this._visibilityCacheGeneration)},e.prototype.isNodeVisible=function(e){var t=this.getNodeInternal(e);if(i.isNone(t)||t.ref&&!t.ref.mbs)return!0;if(!function(e,t){return(-2&e)===t}(t.visibilityCache,this._visibilityCacheGeneration)){var r=this.viewportQueries.isNodeVisible(t.ref||t.node);return t.visibilityCache=function(e,t){return t+(e?1:0)}(r,this._visibilityCacheGeneration),r}return function(e){return 1==(1&e)}(t.visibilityCache)},e.prototype.isGeometryVisible=function(e){if(!this.isNodeVisible(e))return!1;var t=this.getNodeInternal(e);return!!i.isNone(t)||!(t.node&&t.ref&&!t.ref.obb)||this.viewportQueries.isGeometryVisible(t.node)},Object.defineProperty(e.prototype,"maxLevel",{get:function(){return this._maxLevel},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dirty",{get:function(){return this._dirty},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){this._updates.add.prune(),this._updates.update.prune()},e.prototype.requestUpdate=function(){this._dirty=!0,this._indexMissing=1,++this._version},e.prototype.update=function(e,t){var r=this;if(this._dirty){this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e,this._missing),v.clear();var n=!0,o=new x,a=new x;this.traverseVisible(function(s,l){if(!l){var d=r.entryPriority(s),u=p(s,r.nodesPerPage);return v.set(u,Math.max(d,v.get(u)||0)),r._loading.has(u)||r._failedPages.has(u)||r._missing.push(u),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,d))}var c=l.node;if(r._updateNodeFeatureEstimate(c,a),!c){var h=r.entryPriority(s);return r._loading.has(s)||r._failedNodes.has(s)||(r._missing.push(s),v.set(s,h)),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,h))}var f=i.expect(r.getPage(s));if(0===r._missing.length&&0===r.nodesPerPage)for(var g=0;g<l.childCount;g++){var y=f.children[l.childOffset+g],m=r.getNodeInternal(y);!i.isSome(m)||m.node||r._loading.has(y)||(v.set(y,r.entryPriority(y)),r._prefetch.push(y))}if(!c.failed&&c.resources.hasFeatureData)if(r._isLoaded(s)){if(o.known+=c.memory,++o.knownNodes,r._isSelected(c)?l.childCount>0&&(n=!1):(o.unremoved+=c.memory,n=!1),r._needsUpdate(c)){var _=r.entryPriority(s);v.set(s,_),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,_),r._updates.update.push(s)}}else if(c.memory&&(o.known+=c.memory,++o.knownNodes),r._isSelected(c)){if(l.childCount>0&&(n=!1),c.memory?(o.missing+=c.memory,o.known+=c.memory,++o.knownNodes):++o.missingNodes,e.indexOf(c.index)>=0)return r._maxProcessingPrio=Math.max(r._maxProcessingPrio,r.entryPriority(s)),void(r._updates.cancel=r._updates.cancel.filter(function(e){return e!==c.index}));if(!t.done&&r._enable(c))return void t.madeProgress();var b=r.entryPriority(s);v.set(s,b),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,b),r._updates.add.push(s)}}),this._unloadedMemoryEstimate=o.missing-o.unremoved,o.knownNodes>3&&o.missingNodes>0&&(this._unloadedMemoryEstimate+=o.known/o.knownNodes*o.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(a),this._featureEstimate.leafsReached=n,this._missing.sort(function(e,t){return e-t}),this._missing.filterInPlace(function(e,t){return t<1||r._missing.data[t-1]!==e}),this._missing.sort(function(e,t){return v.get(e)-v.get(t)}),this._missing.length>0?(this._maxUnloadedPrio=v.get(this._missing.back()),this._prefetch.clear()):this._prefetch.sort(function(e,t){return v.get(e)-v.get(t)}),this._updates.add.filterInPlace(function(e){return v.get(e)>=r._maxUnloadedPrio}).sort(function(e,t){return v.get(e)-v.get(t)}),this._updates.update.sort(function(e,t){return v.get(e)-v.get(t)}),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,v.clear()}},e.prototype.checkFeatureTarget=function(e,t){for(var r=this.viewportQueries.updateScreenSpaceErrorBias(t),i=t,n=t,o=r,a=10;a--;){var s=new x;if(this._updateFeatureEstimate(i,s),this._computeFeatureEstimate(s)<=e){if(i>=t||s.missingNodes>0||0===a)break;o=i,i=.5*(i+n)}else n=i,i=.5*(i+o)}return++this._version,this.viewportQueries.updateScreenSpaceErrorBias(r),Math.min(t,i)},e.prototype._updateFeatureEstimate=function(e,t){var r=this;++this._version,this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(function(e,i){return r._updateNodeFeatureEstimate(i&&i.node,t)})},e.prototype._updateNodeFeatureEstimate=function(e,t){if(e&&!e.failed&&null!=e.numFeatures)return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},e.prototype._computeFeatureEstimate=function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)},e.prototype.load=function(e){if(0===this._missing.length)return!1;e=Math.min(e,this._missing.length);for(var t=0;t<e;++t)0===this.nodesPerPage?this._loadNode(this._missing.pop()):this.loadPage(this._missing.pop());return!0},e.prototype.prefetch=function(e){if(0===this._prefetch.length)return!1;e=Math.min(e,this._prefetch.length);for(var t=0;t<e;++t)this._loadNode(this._prefetch.pop());return!0},e.prototype.isLoading=function(){return this._indexMissing>0},e.prototype.getIndexLoading=function(){return this._loading.size},e.prototype.getIndexMissing=function(){return this._indexMissing},e.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate},Object.defineProperty(e.prototype,"updates",{get:function(){return this._updates},enumerable:!0,configurable:!0}),e.prototype.getFeatureEstimate=function(){return this._featureEstimate},e.prototype.nodeTraversalState=function(e){if(!e)return null;var t=this._nodeTraversalState[e.index];if(t&&t.version===this._version)return t;var r=this.viewportQueries.getLodLevel(e),i=this.viewportQueries.hasLOD(e),n=!0;if(i){var o=this.getParentIndex(e.index);if(o>=0){var a=this._nodeTraversalState[o];n=a&&r>a.lodLevel}else n=r>0}return t?(t.lodLevel=r,t.isChosen=n,t.version=this._version,t):(this._nodeTraversalState[e.index]={nodeHasLOD:i,lodLevel:r,isChosen:n,version:this._version},this._nodeTraversalState[e.index])},e.prototype._loadNode=function(e){var t=this;this._loading.add(e);var r=i.expect(this.getNodeInternal(e)).ref.id,n=this.layerUrl+"/nodes/"+r,a=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this.streamDataController.request(n,"json").then(function(i){var n=t._validateNode(r,i);if(null!=n){n.obb&&t.invalidateVisibilityCache(e);var o=t.addNode(n,e);t.nodeTraversalState(o),a()}else a()},function(r){o.isAbortError(r)||(t.logger.error("Error loading node: "+n),t._failedNodes.add(e)),a()})},e.prototype._validateNode=function(e,t){var r=this;if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error('Invalid node. Wrong type or wrong id "'+e+'"'),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn('Invalid shared resource href on node "'+e+'"'),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn('Invalid geometry data on node "'+e+'"'),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some(function(e,t){return e.href!=="./attributes/f_"+t+"/0"})||this.logger.warn('Invalid attribute data on node "'+e+'"'),t.featureData&&t.featureData.length>1&&this.logger.warn("Node "+e+" has "+t.featureData.length+" bundles. Only the first bundle will be loaded.");var i=t.hasOwnProperty("obb")&&!this.ignoreServiceOBB?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,o=Array.isArray(t.children)?t.children.map(function(t){if(null==t)return null;var i=function(t){return r.logger.error("Invalid node reference on node "+e+": "+t)};if("number"==typeof t.id)i("id "+t.id+" is a number instead of a string.");else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i("Invalid bounding volume on reference "+t.id+"."),null;t.href&&t.href!=="../"+t.id&&r.logger.error('Invalid node href on node "'+e+'"');var n=t.hasOwnProperty("obb")&&!r.ignoreServiceOBB?t.obb:null;return{id:""+t.id,mbs:t.mbs,obb:n}}).filter(function(e){return null!=e}):null;return{id:e,mbs:t.mbs,obb:i,children:o,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}},e.prototype.resetFailedNodes=function(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes(function(e){e.node&&(e.node.failed=!1)})},e.prototype.entryPriority=function(e){var t=this.getNodeInternal(e),r=this.getParentIndex(e);if(i.isNone(t)||r<0&&null==t.node)return r<0?1/0:this.entryPriority(r);var n=0;if(t.node&&r>=0){var o=this._nodeTraversalState[r];null!=o&&(n=o.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var l=this.viewportQueries.distToPOI(t.ref||t.node);return-l-n*(l+this.progressiveLoadPenalty)+a},e.prototype.traverseVisible=function(e){var t=this.getNodeInternal(this.rootIndex);i.isSome(t)?this._traverse(this.rootIndex,t,e):e(this.rootIndex,null)},e.prototype._traverse=function(e,t,r){if(t.node&&0===t.childCount)this.isGeometryVisible(e)&&r(e,t);else if(this.isNodeVisible(e)&&(r(e,t),null!=t.node)){var n=this.nodeTraversalState(t.node);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var o=i.expect(this.getPage(e)),a=0;a<t.childCount;a++){var s=o.children[t.childOffset+a],l=this.getNodeInternal(s);i.isSome(l)?this._traverse(s,l,r):r(s,null)}}},e.prototype.traverse=function(e,t){t(e)&&this.traverseChildren(e,t)},e.prototype.traverseChildren=function(e,t){var r=e.index,n=this.getNodeInternal(r);i.isSome(n)&&this._traverseChildren(r,n,t)},e.prototype._traverseChildren=function(e,t,r){var n=this.getPage(e);if(!i.isNone(n))for(var o=0;o<t.childCount;++o){var a=n.children[t.childOffset+o],s=this.getNodeInternal(a);i.isSome(s)&&s.node&&r(s.node)&&this._traverseChildren(a,s,r)}},e.prototype.updateStats=function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||!1),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},e.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)},e.prototype.updateElevationInfo=function(e){this.forAllNodes(u),this.viewportQueries.updateElevationInfo(e)},e.prototype.invalidateBoundingVolumeCache=function(e){var t=this.getNodeInternal(e);i.isSome(t)&&u(t)},e.prototype.forAllNodes=function(e){for(var t=0;t<this.nodePages.length;t++){var r=this.nodePages[t];if(r)for(var i=t*this.nodesPerPage,n=0;n<r.nodes.length;n++)e(r.nodes[n],i+n)}},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{addNode:function(t,r){return e.addNode(t,r)}}},enumerable:!0,configurable:!0}),e}();t.I3SIndex=m;var v=new Map,_=function(){function e(){this.update=new n({deallocator:null}),this.add=new n({deallocator:null}),this.cancel=[]}return e.prototype.reset=function(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t},e}(),b=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];t.selectErrorMetric=g;var x=function(){return function(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}()}.apply(null,i))||(e.exports=n)},1567:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(86)],void 0===(n=function(e,t,r){var i=function(){function e(e,t){this.layerView=e,this.lodGlobalDirtyChanged=t}return e.prototype.startNodeLoading=function(e,t,r,i,n,o,a){this._lodGlobalDirty=!1,this._maxLodLevel=a.maxLodLevel,this._index=o,this._nodeTraversalState=i,this._isNodeVisible=e,this._isGeometryVisible=t,this._isNodeInScaleBounds=r,this._removeNodes=n,this.lodGlobalDirtyChanged(this._lodGlobalDirty)},e.prototype.shouldLoadNode=function(e){var t=this._nodeTraversalState(e);return!!this.isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)},e.prototype.setLodGlobalDirty=function(){this._lodGlobalDirty=!0,this.lodGlobalDirtyChanged(this._lodGlobalDirty)},e.prototype.lodSwapNodeLoaded=function(e){this.setLodGlobalDirty()},Object.defineProperty(e.prototype,"requiresLODGlobalHandling",{get:function(){return null!=this._index&&!0===this._lodGlobalDirty},enumerable:!0,configurable:!0}),e.prototype.lodGlobalHandling=function(e){if(this.requiresLODGlobalHandling){var t=this.layerView.view.resourceController.memoryController.usedMemory,r=Math.max(0,Math.floor(10*(t-1)));n.clear(),this._lodGlobalHandlingRecursion(this._index.rootNode,r),this._removeNodes(n,e),0===n.length&&(this._lodGlobalDirty=!1,this.lodGlobalDirtyChanged(this._lodGlobalDirty)),n.clear()}},e.prototype._lodGlobalHandlingRecursion=function(e,t){if(null==e)return!1;var r=this._nodeTraversalState(e),i=this.isChosenMaxLOD(r),o=this.layerView.isNodeLoaded(e.index);if(o&&null!=this.layerView.updateNodeStatus&&this.layerView.updateNodeStatus(e.index,i?"leaf":"hole"),i&&o)return this._removeChildrenRecursive(e),!0;var a=!1;if(e.childCount>0){a=!0;for(var s=0;s<e.childCount;s++){var l=this._index.getChildIndex(e,s),d=this._index.getNode(l);d?this._isGeometryVisible(l)&&!this._lodGlobalHandlingRecursion(d,t)&&this._isNodeInScaleBounds(d)&&(a=!1):this._isNodeVisible(l)&&(a=!1)}}o&&!i&&(a||n.length<t)&&(n.push(e.index),o=!1);var u=!e.resources.hasFeatureData;return a||o||u},e.prototype._removeChildrenRecursive=function(e){this._index.traverseChildren(e,function(e){return n.push(e.index),!0})},e.prototype.childrenEmpty=function(e){var t=this,r=!0;return this._index.traverseChildren(e,function(e){return!(!r||!t._isNodeVisible(e.index)||t.layerView.isNodeLoaded(e.index)&&(r=!1,1))}),r},e.prototype._childrenRequireLoading=function(e){var t=this,r=!1,i=!0;return this._index.traverseChildren(e,function(e){if(!i||!t._isNodeVisible(e.index))return!1;var n=t._nodeTraversalState(e);return t.isChosenMaxLOD(n)&&t._isGeometryVisible(e.index)&&(r=!0),!t.layerView.isNodeLoaded(e.index)||(i=!1,!1)}),i&&r},e.prototype.isChosenMaxLOD=function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)},e}(),n=new r({deallocator:null});return i}.apply(null,i))||(e.exports=n)},1568:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(11),r(13),r(22),r(10),r(14),r(9),r(31),r(1540),r(1495),r(1477),r(18)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h){function p(e,t){if(!e||!t||!t.materialDefinitions)return e;var r=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&delete(e=o.clone(e)).vertexAttributes.region,e}function f(e,t){var r={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return r;var i=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==i)return r;for(var o=0;o<i.length;o++)if(null==i[o].compressedAttributes)r.bufferIndex=o,r.bufferDefinition=i[o];else if("draco"===i[o].compressedAttributes.encoding&&d.isSupported()&&!n("disable-feature:i3s-draco"))return r.bufferIndex=o,r.bufferDefinition=i[o],r;return r}function g(e,t){var r=[];return t&&t.pbrMetallicRoughness&&t.pbrMetallicRoughness.baseColorTexture&&function(t){var i=a.isSome(e)&&e[t]&&e[t].formats;i&&r.push({id:""+t,encodings:i.map(function(e){var t=e.name,r=e.format;return{name:t,encoding:_[r]}})})}(t.pbrMetallicRoughness.baseColorTexture.textureSetDefinitionId),r}function y(e,t){var r,i=g(e,t),n=i[0]&&i[0].id,o=a.isSome(e)&&e[n]&&e[n].atlas,s="opaque"!==t.alphaMode,l=n?((r={})[n]={encoding:i[0].encodings.map(function(e){return e.encoding}),wrap:["none","none"],atlas:o,channels:s?"rgba":"rgb",images:[{id:n,size:0,href:i[0].encodings.map(function(e){return"../textures/"+e.name}),byteOffset:0,length:0}]},r):{},d=t.pbrMetallicRoughness,u=d&&d.baseColorFactor;return{textureDefinitions:l,materialDefinitions:{mat:{type:"standard",params:{diffuse:u?u.slice(0,3):[1,1,1],specular:[1,1,1,1],vertexRegions:o,doubleSided:t.doubleSided,cullFace:t.cullFace,transparency:u?1-u[3]:0,useVertexColorAlpha:s}}}}}function m(e){for(var t={},r=0,i=e;r<i.length;r++){var n=i[r];b[n]&&(t[b[n]]={valueType:null})}return{header:null,byteOffset:0,byteCount:0,vertexAttributes:t}}var v=function(){function e(e,t,r,i,n,o){if(this.streamDataController=t,this.logger=r,this.defaultGeometrySchema=i,this.requiredAttributes=n,this.options=o,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){var a=e.textureSetDefinitions;this.materialTextures=e.materialDefinitions.map(function(e){return g(a,e)}),this.materialShared=e.materialDefinitions.map(function(e){return y(a,e)})}}return e.prototype.load=function(e,t,r){return this.streamDataController.request(e,t,{signal:r})},e.prototype.loadAttribute=function(e,t,r){var i=this.layerUrl+"/nodes/"+e.resources.attributes+"/attributes/"+t.key+"/0";return this.load(i,"binary",r).then(function(e){return u.readBinaryAttribute(t,e)})},e.prototype.loadAttributes=function(e,t,r){var i=this;return s.eachAlways(t.map(function(t){return i.loadAttribute(e,t.attributeStorageInfo,r)})).then(function(r){for(var n={},o=0;o<t.length;++o)r[o].value?n[t[o].name]=r[o].value:s.isAbortError(r[o].error)||i.logger.error("Failed to load attributeData for '"+t[o].name+"' on node '"+e.id+"'");return n})},e.prototype.loadNodeData=function(e,t){return i(this,void 0,void 0,function(){var i,n,o,a,l,d,c,h,g,y,v,_,b,x,w,C,S,D,I;return r(this,function(r){switch(r.label){case 0:return i=null!=this.requiredAttributes&&e.resources.attributes?this.loadAttributes(e,this.requiredAttributes,t):s.resolve({}),n=f(this.geometryDefinitions,e),o=n.bufferDefinition,a=n.bufferIndex,l=e.resources.geometry?this.loadGeometry(e,a,t):null,e.resources.hasSharedResource?[4,this.loadShared(e,t)]:[3,2];case 1:return c=r.sent(),[3,3];case 2:c=this.materialShared&&e.resources.materialDefinition>=0?this.materialShared[e.resources.materialDefinition]:null,r.label=3;case 3:return d=c,this.options.loadFeatureData?[4,this.loadFeatureData(e,t)]:[3,5];case 4:return g=r.sent(),[3,6];case 5:g=null,r.label=6;case 6:return h=g,y=this.options.loadFeatureData?this.collectGeometries(h):this.meshPyramidGeometryData(e,d),v=this.materialTextures&&e.resources.materialDefinition>=0?this.materialTextures[e.resources.materialDefinition]:this.getRequiredTexturesFromShared(y,d),_=this.options.loadTextureData?this.loadTextures(e,v,t):null,b=null,x=null,l?[4,l]:[3,8];case 7:b=r.sent(),w=p(this.defaultGeometrySchema,d),C=!(!o||!o.compressedAttributes||"draco"!==o.compressedAttributes.encoding),x=C?m(o.compressedAttributes.attributes):o?u.createGeometryIndexFromDefinition(o,e.vertexCount,e.numFeatures):u.createGeometryIndexFromSchema(b,w),r.label=8;case 8:return[4,_];case 9:return S=r.sent(),[4,i];case 10:return D=r.sent(),I=null,D&&(I={attributeData:D,loadedAttributes:this.requiredAttributes}),[2,{allGeometryData:y,attributeDataInfo:I,geometryBuffer:b,geometryIndex:x,sharedResource:d,requiredTextures:v,textureData:S}]}})})},e.addAbsoluteHrefTexture=function(e,t){var r=e.textureDefinitions;if(null!=r)for(var i=0,n=Object.keys(r);i<n.length;i++)for(var o=0,a=r[n[i]].images;o<a.length;o++){var s=a[o];Array.isArray(s.href)?s.hrefConcat=s.href.map(function(e){return l.makeAbsolute(e,t)}):s.hrefConcat=l.makeAbsolute(s.href,t)}},e.fixTextureEncodings=function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var i=t[r];if(Array.isArray(i.encoding))for(var n=0;n<i.encoding.length;n++){var o;"data:"===(o=i.encoding[n]).substring(0,5)&&(i.encoding[n]=o.substring(5))}else"data:"===(o=i.encoding).substring(0,5)&&(i.encoding=o.substring(5))}},e.prototype.loadShared=function(t,r){var i=this.layerUrl+"/nodes/"+t.resources.geometry+"/shared";return this.load(i,"json",r).then(function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,i),t})},e.prototype.loadTexture=function(e,t,r,i,n){return i===c.DDS_ENCODING_STRING?this.load(e,"binary",n).then(function(e){return{i3sTexId:t,data:e,encoding:i}}):this.load(e,"image",n).then(function(e){var n=e;if(r&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),a=Math.ceil(e.height/2),s=document.createElement("canvas");s.width=o,s.height=a,s.getContext("2d").drawImage(e,0,0,o,a),n=s}return{i3sTexId:t,data:n,encoding:i}})},e.prototype.loadTextures=function(t,r,i){var n=this,o=this.options.textureFormat===e.TextureFormat.Compressed,a=this.options.textureFormat===e.TextureFormat.Downsampled;return s.all(r.map(function(e){var r=c.selectEncoding(e.encodings,o);if(null==r)return n.logger.error("No known encoding for texture found on node "+t.id),s.reject();var l=t.resources.texture||t.id,d=n.layerUrl+"/nodes/"+l+"/textures/"+r.name;return n.loadTexture(d,e.id,a,r.encoding,i)}))},e.prototype.getRequiredTexturesFromShared=function(e,t){for(var r=[],i=0;i<e.length;i++){var n=e[i].geometries;if(null!=n)for(var o=this,a=0,s=n;a<s.length;a++){!function(e){var i=e.params.textureID||"none";if("none"!==i){null!=t.textureDefinitions&&null!=t.textureDefinitions[i]||o.logger.warn("textureDefinitions missing in shared resource. i3sTexId: "+i);var n=t.textureDefinitions[i];if(h.assert(void 0!==n,"geometry wants unknown texture "+i),0===n.images.length)return"continue";var a=n.images.length-1,s=n.images[a],l=function(e){return e&&e.split("/").pop()},d=Array.isArray(n.encoding)?n.encoding.map(function(e,t){return{name:l(s.href[t]),encoding:e}}):[{name:l(s.href),encoding:n.encoding}];r.push({id:i,encodings:d})}}(s[a])}}return r},e.prototype.meshPyramidGeometryData=function(e,t){return[{featureIds:[],geometries:[{type:"ArrayBufferView",params:{materialID:t&&t.materialDefinitions?Object.keys(t.materialDefinitions)[0]:null,textureID:t&&t.textureDefinitions?Object.keys(t.textureDefinitions)[0]:null}}],featureDataPosition:[0,0,0]}]},e.prototype.collectGeometries=function(e){for(var t=new Array,r=0,i=e.featureData;r<i.length;r++){var n=i[r],o=n.geometries;if(null!=o)for(var a=0,s=o;a<s.length;a++){var l=s[a];t.push({featureIds:[n.id],featureDataPosition:n.position,geometries:[l]})}else null!=n.position&&t.push({featureIds:[n.id],featureDataPosition:n.position,geometries:null})}return t},e.prototype.loadFeatureData=function(e,t){var r=this.layerUrl+"/nodes/"+e.id+"/features/0";return this.load(r,"json",t)},e.prototype.loadGeometry=function(e,t,r){var i=this.layerUrl+"/nodes/"+e.resources.geometry+"/geometries/"+t;return this.load(i,"binary",r)},e}(),_={jpg:"image/jpeg",png:"image/png",dds:"image/vnd-ms.dds","ktx-etc2":"image/ktx"},b={position:"position",normal:"normal",uv0:"uv0",uv1:"uv1",color:"color","uv-region":"region"};return function(e){!function(e){e[e.Compressed=0]="Compressed",e[e.Normal=1]="Normal",e[e.Downsampled=2]="Downsampled"}(e.TextureFormat||(e.TextureFormat={}))}(v||(v={})),v}.apply(null,i))||(e.exports=n)},1569:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(7),r(9)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.requester=e,this.activeRequests=new Set}return e.prototype.request=function(e,t,n){var o=this,a=i.createAbortController();i.onAbortOrThrow(n,function(){return a.abort()}),n=r({},n,{signal:a.signal});var s=this.requester(e,t,n),l={response:s,abortController:a};return this.activeRequests.add(l),i.always(s,function(){return o.activeRequests.delete(l)}),s},e.prototype.cancelAll=function(){this.activeRequests.forEach(function(e){return e.abortController.abort()}),this.activeRequests.clear()},e}();t.I3SStreamDataController=n,t.default=n}.apply(null,i))||(e.exports=n)},1570:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(4),r(3),r(55),r(33),r(95),r(373),r(172),r(90),r(1477),r(30),r(1489),r(38)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h,p){return function(){function e(e,t,r,n,o,s,l){void 0===l&&(l={}),this.indexSR=e,this._renderCoordsHelper=t,this.extent=n,this.elevationProvider=o,this.options=l,this.fp=c.frustum.create(),this._poi=i.vec3f64.create(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=i.vec3f64.create(),this._tmp2=i.vec3f64.create(),this._tmp3=i.vec3f64.create(),this._tmp0=i.vec3f64.create(),this.screenspaceErrorBias=l.screenspaceErrorBias||1,this.progressiveLoadFactor=l.progressiveLoadFactor||1,this.updateCamera(r),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(s.elevationInfo),this.tmpPoint=a.makeDehydratedPoint(0,0,0,e)}return e.prototype.updateElevationInfo=function(e){null!=e?(this._elevationContext=new s,this._elevationContext.featureExpressionInfoContext=l.createContext(l.extractExpressionInfo(e,!1)),this._elevationContext.mixinApi(e)):this._elevationContext=null},e.prototype.updateCamera=function(e){c.frustum.fromMatrix(e.viewMatrix,e.projectionMatrix,this.fp),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0},e.prototype.setPointOfInterest=function(e){r.vec3.copy(this._poi,e)},e.prototype.updateScreenSpaceErrorBias=function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t},e.prototype.updateExtent=function(e){this.extent=e},e.prototype.getRenderMbs=function(e){var t=e.renderMbs;return t||(t=o.vec4f64.fromValues(e.mbs[0],e.mbs[1],e.mbs[2],-1),e.renderMbs=t),t[3]<0&&(n.vec4.copy(t,e.mbs),this._elevationContext&&t[3]<1e5&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=d.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)),p.mbsToMbs(t,this.indexSR,t,this.engineSR)),t},e.prototype.getRenderObb=function(e){if(e.obb&&!(e.obb.halfSize[0]<0)&&e.renderObb){var t=e.renderObb;return t.halfSize[0]<0&&(h.set(e.obb,t),this._elevationContext&&e.mbs[3]<1e5&&(this.tmpPoint.x=e.obb.center[0],this.tmpPoint.y=e.obb.center[1],this.tmpPoint.z=e.obb.center[2],t.center[2]=d.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)),p.bufferToBuffer(t.center,this.indexSR,0,t.center,this.engineSR,0,1)),t}},e.prototype.isNodeVisible=function(e){var t=this.getRenderMbs(e);if(!this.isMBSinExtent(t))return!1;if(e.obb){var r=this.getRenderObb(e);return h.isVisible(r,this.fp)}return this.isMBSVisible(t)},e.prototype.isGeometryVisible=function(e){var t=this.getRenderObb(e);return!t||h.isVisible(t,this.fp)},e.prototype.isMBSinExtent=function(e){return!this.extent||0!==u.intersectBoundingBoxWithMbs(this.extent,e)},e.prototype.isMBSVisible=function(e){return c.frustum.intersectsSphere(this.fp.planes,c.sphere.wrap(e[3],e))},e.prototype.screenSpaceDiameterMbs=function(e,t){var i=this.getRenderMbs(e),n=Math.sqrt(r.vec3.squaredDistance(i,this._camPos)),o=n-i[3];return this._updateMinMaxDistance(n),o<0?.5*Number.MAX_VALUE:t/o*this._screenSizeFactor},e.prototype.calcCameraDistance=function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]},e.prototype.calcCameraDistanceToCenter=function(e){var t=this.getRenderMbs(e),i=r.vec3.distance(t,this._camPos);return this._updateMinMaxDistance(i),i},e.prototype.calcAngleDependentLoD=function(e){var t=this.getRenderMbs(e),i=t[3],n=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/r.vec3.length(t)+i)/r.vec3.distance(t,this._camPos);return Math.min(1,n)},e.prototype.hasLOD=function(e){return 0!==e.lodMetric},e.prototype.getDistancePlanarMode=function(e,t){var r=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2],o=r*r+i*i,a=t[3];if(o<=a*a)return Math.abs(n);var s=Math.sqrt(o)-a;return Math.sqrt(n*n+s*s)},e.prototype.getDistanceGlobeMode=function(e,t){var i=r.vec3.length(t),n=r.vec3.length(e)-i;r.vec3.scale(this._tmp0,e,r.vec3.dot(e,t)/r.vec3.squaredLength(e));var o=r.vec3.squaredDistance(t,this._tmp0),a=t[3];if(o<=a*a)return Math.abs(n);var s=r.vec3.scale(this._tmp0,t,1/i),l=i,d=a*a/2/l,u=r.vec3.scale(this._tmp1,s,l-d),c=e,h=r.vec3.subtract(this._tmp2,c,u),p=r.vec3.subtract(this._tmp2,h,r.vec3.scale(this._tmp3,s,r.vec3.dot(s,h))),f=r.vec3.add(this._tmp2,u,r.vec3.scale(this._tmp2,p,a/r.vec3.length(p))),g=r.vec3.distance(c,f);if(n>=2e5){var y=r.vec3.subtract(this._tmp1,c,f),m=r.vec3.dot(y,s)/r.vec3.length(y);m<.08&&(m=1e-4),g/=m}return g},e.prototype.getDistance=function(e,t){return this.engineSR===p.SphericalECEFSpatialReference?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)},e.prototype._updateMinMaxDistance=function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))},e.prototype.getLodLevel=function(e){if(0===e.lodMetric||!e.resources.hasFeatureData)return 0;if(0===e.childCount)return this.maxLodLevel;if(this.progressiveLoadFactor<1){var t=this.progressiveLoadFactor*this.screenspaceErrorBias,r=this.screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,r)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias)?this.maxLodLevel:0},e.prototype.evaluateLODmetric=function(e,t){switch(e.lodMetric){case 2:var r=this.getRenderMbs(e),i=this.getDistance(this._camPos,r),n=2*i/this._screenSizeFactor,o=i+r[3];return this._updateMinMaxDistance(o),e.maxError*t<=n;case 1:var a=this.screenSpaceDiameterMbs(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(a*=this.calcAngleDependentLoD(e)),a<e.maxError;case 3:return this.screenSpaceDiameterMbs(e,e.maxError)*t<10;case 4:return this.calcCameraDistance(e)>e.maxError*t}return!1},e.prototype.distToPOI=function(e){var t=this.getRenderMbs(e);return r.vec3.distance(t,this._poi)-t[3]},e.prototype.distCameraToPOI=function(){return r.vec3.distance(this._camPos,this._poi)},e}()}.apply(null,i))||(e.exports=n)},1623:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(7),r(2),r(1),r(11),r(13),r(23),r(84),r(52),r(28),r(37),r(348),r(22),r(207),r(12),r(24),r(14),r(201),r(9),r(353),r(59),r(108),r(111),r(69),r(29),r(352),r(0),r(19),r(4),r(3),r(43),r(1564),r(1493),r(354),r(138),r(370),r(1422),r(78),r(1624),r(1625),r(1583),r(1477),r(1626),r(1518),r(379),r(1482),r(591),r(16),r(1489),r(38),r(98),r(79),r(80),r(365),r(112),r(572),r(136),r(18),r(587),r(1627),r.dj.m(e)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h,p,f,g,y,m,v,_,b,x,w,C,S,D,I,P,M,N,O,V,T,L,E,R,A,j,F,G,B,U,k,z,q,H,Q,W,J,K,X,Y,Z,$,ee,te,re,ie,ne,oe,ae,se){function le(e){return m.isSome(e)&&C.isArrayBuffer(e.data)}function de(e,t){for(var r=1024,i=0,n=e;i<n.length;i++){var o=n[i];r+=o.interleavedVertexData.byteLength+(o.indices?o.indices.byteLength:0),r+=o.positionData.data.byteLength+o.positionData.indices.byteLength}if(m.isSome(t))for(var a=0,s=t;a<s.length;a++){var l=s[a];m.isSome(l)&&C.isArrayBuffer(l.data)&&(r+=l.data.byteLength)}return r}function ue(e,t){return t.byteSize>ye?(he.warn("Node is too big to store in IndexedDB cache: "+e.id+" ("+t.byteSize+" bytes)"),!1):t.byteSize>0}Object.defineProperty(t,"__esModule",{value:!0});var ce=Z.ModelContentType,he=g.getLogger("esri.views.3d.layers.SceneLayerView3D"),pe=[1,1,1,1],fe=[.8,.8,.8],ge=function(){return function(){}}(),ye=104857600,me=function(t){function s(){var e=null!==t&&t.apply(this,arguments)||this;return e._layerUid="",e._highlights=new G(e),e._elevationProvider=null,e._worker=new j,e._workerThread=null,e._nodeId2Meta=new Map,e._addTasks=new Map,e._rendererVersion=0,e._rendererFields=null,e._colorVariable=null,e._opacityVariable=null,e._symbolInfos=new Map,e._idbCache=new z.IDBCache("esri-scenelayer-cache","geometries"),e._cancelCount=0,e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.slicePlaneEnabled=!1,e._layerUrl="",e._cacheKeySuffix=null,e._tmpAttributeOnlyGraphic=new l(null,null,{}),e}return i(s,t),Object.defineProperty(s.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"rendererNeedsTextures",{get:function(){return k.rendererNeedsTextures(this._currentRenderer)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"elevationOffset",{get:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=S.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=A.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"useCompressedTextures",{get:function(){var e=this.layer.version,t=!p("trident")||e.major>1||1===e.major&&e.minor>3;return this.view._stage.renderView.has("s3tc")&&t},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.renderView.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0}),s.prototype.initialize=function(){var t=this;if(I.open(b.getAbsMid("./SceneLayerWorker",e,se)).then(function(e){t.destroyed?e.close():t._workerThread=e}),k.checkSceneLayerValid(this.layer),k.checkSceneLayerCompatibleWithView(this.layer,this.view),this._layerUid=this.layer.uid,this._layerUrl=this.layer.parsedUrl.path,this._controller=new T({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var r=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(r&&r.faceRange&&r.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,function(e){return t._deleteNodeStageData(e)}),this._addThisLayerToStage(),this._elevationProvider=new B({layerView:this,stageLayer:this._stageLayer}),this.handles.add([D.init(this.view,"clippingArea",function(){return t._clippingAreaChanged()}),D.watch(this,"fullOpacity",function(e){return t._opacityChange(e)}),D.watch(this,"slicePlaneEnabled",function(e){return t._slicePlaneEnabledChange(e)}),D.watch(this,"elevationOffset",function(e,r){return t._reloadAll(r)}),D.init(this,"filter",function(){return t._filterChange()}),D.watch(this,["rendererNeedsTextures","uncompressedTextureDownsamplingEnabled"],function(){t._reloadAll(),t._memCache.clear()}),D.init(this,"suspended",function(e){return t._suspendedChange(e)})],"sceneLayerHandles"),this._cacheKeySuffix=k.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch(function(e){return he.warn("Failed to initialize IndexedDB cache: "+e)}),this._componentColorManager=this._hasSymbolColors?new oe.BufferManager(this._stage.renderView.renderingContext):null},s.prototype.destroy=function(){this.handles.remove("sceneLayerHandles"),this._workerThread&&(this._workerThread.close(),this._workerThread=null),this._removeAllNodeDataFromStage(),this._memCache.destroy(),this._memCache=null,this._removeThisLayerFromStage(),this._stage=null,this._idbCache&&(this._idbCache.destroy(),this._idbCache=null),null!=this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._nodeId2Meta=null,this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)},s.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequired();return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t},s.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequired();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},s.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage();return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t},s.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage();this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},s.prototype.isNodeLoaded=function(e){return this._nodeId2Meta.has(e)},s.prototype.getUsedMemory=function(){var e=0;return this._nodeId2Meta.forEach(function(t){return e+=t.node.memory}),e},s.prototype.getUnloadedMemory=function(){return this._controller?this._controller.unloadedMemoryEstimate:0},s.prototype.ignoresMemoryFactor=function(){return!1},s.prototype._suspendedChange=function(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider.unregister(this._elevationProvider)):this.view.elevationProvider.register(this._elevationContext,this._elevationProvider)},s.prototype.getStats=function(){var e={index:0,nodes:this._nodeId2Meta.size.toString(),"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};return this._controller&&(this._cachingEnabled()&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e},s.prototype._addThisLayerToStage=function(){for(var e=this._stage,t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;var i=""+this.layer.uid,n=new ee(i,{},i);this._stageLayer=n,e.add(ce.LAYER,n),this._stage.addToViewContent([n.id])},s.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var e=this._stage;this._removeAllNodeDataFromStage(),ne.verify(0===this._nodeId2Meta.size),e.remove(ce.LAYER,this._stageLayer.id),this._stageLayer=void 0,this.gpuMemoryEstimate=0}},s.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta.get(e);if(t&&t.attributeInfo)return t.attributeInfo.loadedAttributes},s.prototype.getAttributeData=function(e){var t=this._nodeId2Meta.get(e);if(t&&t.attributeInfo)return t.attributeInfo.attributeData},s.prototype.setAttributeData=function(e,t){var r=this._nodeId2Meta.get(e);r&&(r.attributeInfo=t,r.cachedRendererVersion=this._getInvalidRendererVersion(),r.filteredIds=null,this._updateEngineObject(r))},s.prototype.getLoadedNodeIds=function(){var e=[];return this._nodeId2Meta.forEach(function(t){return e.push(t.node.id)}),e.sort()},s.prototype.getLoadedNodeIndices=function(e){this._nodeId2Meta.forEach(function(t,r){return e.push(r)})},s.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){if(this._isIntegratedMesh)return{forceTransparency:!1};var i=this.fullOpacity,n=1-y.clamp(ne.fallbackIfUndefined(t.transparency,0),0,1);return{baseColorOpacity:n,layerOpacity:i,forceTransparency:!!(n<1||i<1||e&&w.endsWith(e.channels,"a")||!0===t.useVertexColorAlpha||r)}},s.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null==e.doubleSided||e.doubleSided},s.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},s.prototype._getMaterialParameters=function(e,t,i){var n=t.params,o=ne.fallbackIfUndefined(n.diffuse,fe);"standard"!==t.type&&he.warn("Unknown material type '"+t.type+"', must be 'standard'");var a=this._isIntegratedMesh,s=this._calcEngineMaterialTransparencyParams(e,n);return r({baseColor:o,baseColorTexture:i,doubleSidedShading:this._calcEngineMaterialDoubleSidedParams(n),cullFace:this._calcEngineMaterialCullFaceParams(n),writeStencil:a,receiveSSAO:!a,normals:a?"ground":"vertex"},s)},s.prototype._getGeometryParameters=function(e){return{textureCoordinates:e.hasTexture,textureCoordinateRegions:e.hasTexture&&e.hasRegions,colors:this._hasVertexColors,componentData:this._hasSymbolColors,normals:this._isIntegratedMesh?"none":e.hasNormals?"compressed":"screen-space"}},s.prototype._createTexture=function(e,t,r,i,n){if(null==t||m.isNone(i))return null;var o=function(e,t){for(var r=0,i=e;r<i.length;r++){var n=i[r];if(m.isSome(n)&&n.i3sTexId===t)return n}return null}(i,r),a=o.data,s=o.encoding;if(null==a)return null;var l,d="none"!==t.wrap[0]||"none"!==t.wrap[1],u="rgba"===t.channels,c=!0;if(s===k.DDS_ENCODING_STRING)l=ie.DDS_ENCODING;else{var h=a;c=J.isPowerOfTwo(h.width)&&J.isPowerOfTwo(h.height)}var p=n||!0===t.atlas,f=(p?this._enableAtlasMipMaps:this._enableMipMaps)&&c,g=p||!d,y=p&&f&&this._disableAtlasAnisotropy,v=new ie(a,r,{mipmap:f,wrap:g?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:y,encoding:l,noUnpackFlip:!0,components:u?4:3});return this._stage.add(ce.TEXTURE,v),e.memory+=this.memEstimateTextureAdded(v),v},s.prototype._getVertexBufferLayout=function(e,t,r){var i=e.params.textureID||"none",n={hasTexture:"none"!==i&&null!=t.textureDefinitions[i],hasNormals:null!=r.vertexAttributes.normal,hasRegions:null!=r.vertexAttributes.region};return Y.glLayout(ae.ComponentMaterial.vertexBufferLayout(this._getGeometryParameters(n)))},s.prototype._createEngineMaterial=function(e,t,r,i,n){var o=t.params.materialID,a=r.materialDefinitions[o];ne.assert(void 0!==a,"geometry wants unknown material "+o);var s,l=t.params.textureID||"none";"none"!==l&&(null!=r.textureDefinitions&&null!=r.textureDefinitions[l]||he.warn("textureDefinitions missing in shared resource"),s=r.textureDefinitions[l]);var d=a.params.vertexRegions,u=null!=s?this._createTexture(e,s,l,i,d):null,c=this._getMaterialParameters(s,a,u&&u.id),h=this._getGeometryParameters({hasTexture:null!=s,hasRegions:n.some(function(e){return"region"===e.name}),hasNormals:n.some(function(e){return"normal"===e.name||"normalCompressed"===e.name})}),p=ae.ComponentMaterial.create(c,h,o);return p.metadata={i3sTex:s,i3sMatParams:a.params,engineTex:u},p},s.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},s.prototype._findGraphicNodeAndIndex=function(e){var t=q.attributeLookup(e.attributes,this._getObjectIdField()),r=null;return f.everyMap(this._nodeId2Meta,function(e,i){var n=e.featureIds.indexOf(t);return-1===n||(r={node:e.node,index:n},!1)}),r},s.prototype._getGraphicIndices=function(e,t){var r=this._nodeId2Meta.get(e.index);if(!r)return[];for(var i=[],n=this._getObjectIdField(),o=0,a=t;o<a.length;o++){var s=a[o],l=q.attributeLookup(s.attributes,n),d=r.featureIds.indexOf(l);-1!==d&&i.push(d)}return i},s.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return _.reject();var r=this._nodeId2Meta.get(t.node.index).engineObject,i=this._boundingBoxCornerPoints(t.index,r,new Float64Array(24));if(X.bufferToBuffer(i,this.view.renderSpatialReference,0,i,this.view.spatialReference,0,8)){var n=V.empty();return V.expandWithBuffer(n,i,0,8),_.resolve({boundingBox:n,screenSpaceObjects:[]})}},s.prototype.whenGraphicAttributes=function(e,t){var r=this;return k.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,function(e){for(var t=new Map,i=[],n=0,o=e;n<o.length;n++){var a=o[n],s=r._findGraphicNodeAndIndex(a),l=t.get(s.node);l||(l={node:s.node,indices:[],graphics:[]},i.push(l)),l.indices.push(s.index),l.graphics.push(a)}return i},{ignoreUnavailableFields:!0,populateObjectId:!0})},s.prototype.getGraphicFromStageObject=function(e,t){if(this._isIntegratedMesh)return null;var r=this._getMetadata(e),i=e.getComponentFromTriangleNr(0,t);return null!=i&&null!=r.featureIds&&i<r.featureIds.length?this._createGraphic(i,r):null},s.prototype.hasStageObject=function(e){var t=e.getMetadata(),r=this._nodeId2Meta.get(t.nodeIndex);return r&&r.engineObject===e},s.prototype._getMetadata=function(e){var t=e.getMetadata();return this._nodeId2Meta.get(t.nodeIndex)},s.prototype._getCacheKey=function(e){return this._layerUrl+"/v2/"+e.id+this._cacheKeySuffix},s.prototype._getMemCacheKey=function(e,t){return void 0===t&&(t=this.elevationOffset),e+"#"+t},s.prototype._cachingEnabled=function(){return!this._controller.disableIDBCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix},s.prototype.additionalCancelNodeLoadingHandler=function(){this._cancelCount=k.addWraparound(this._cancelCount,1)},s.prototype._handleCancelled=function(e){if(k.addWraparound(this._cancelCount,-e)>0)throw _.createAbortError()},s.prototype.loadCachedGPUData=function(e){return this._memCache.pop(this._getMemCacheKey(e.index))},s.prototype.loadCachedNodeData=function(e,t){var r=this,i=this._cancelCount;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(e)).then(function(n){return null==n?null:(r._handleCancelled(i),n.nodeVersion!==e.version?(r._idbCache.remove(r._getCacheKey(e)),null):(e.obb||(e.obb=K.clone(n.nodeObb),r._controller.updateVisibility(e.index)),r.rendererNeedsTextures&&function(e,t){for(var i=0;i<e.length;i++){if(m.isNone(t))return!0;var n=k.selectEncoding(e[i].encodings,r.useCompressedTextures),o=t[i];if(m.isNone(o)||null==o.data||n&&o.encoding!==n.encoding)return!0}return!1}(n.requiredTextures,n.textureData)?t(n.requiredTextures).then(function(t){return n.textureData=t,n.byteSize=de(n.transformedGeometries,n.textureData),t.every(le)&&ue(e,n)&&r._idbCache.initialized&&r._idbCache.put(r._getCacheKey(e),n).catch(function(t){return he.warn("Failed to update node with textures in IndexedDB cache: "+e.id+": "+t)}),r._handleCancelled(i),n}):n))}):_.resolve(null)},s.prototype.addNodeData=function(e,t){var i=this;return 0===t.allGeometryData.length||0===t.allGeometryData[0].geometries.length?_.resolve():(1!==t.allGeometryData.length&&console.warn("Node with",t.allGeometryData.length,"geometries is unsupported"),this._addData(e,t.attributeDataInfo,function(){return i._transformNode(e,t).then(function(t){return i._controller.reschedule(e.index,t)}).then(function(n){e.obb||(e.obb=n.obb,i._controller.updateVisibility(e.index)),t.allGeometryData[0].componentOffsets=n.componentOffsets,n.featureIds&&(t.allGeometryData[0].featureIds=Array.prototype.slice.call(n.featureIds));var o={geometryData:t.allGeometryData[0],transformedGeometries:n.transformedGeometries,requiredTextures:t.requiredTextures,textureData:t.textureData,sharedResource:t.sharedResource,nodeVersion:e.version,nodeObb:e.obb,byteSize:i._cachingEnabled()?de(n.transformedGeometries,t.textureData):0};if(ue(e,o)&&i._idbCache.initialized){var a=m.isSome(o.textureData)?o.textureData.map(function(e){return le(e)?e:null}):null;i._idbCache.put(i._getCacheKey(e),r({},o,{textureData:a})).catch(function(t){return he.warn("Failed to store node in IndexedDB cache: "+e.id+": "+t)})}return i._addCachedNodeData(e,o)})}))},s.prototype._transformNode=function(e,t){for(var r=this,i=t.allGeometryData[0].geometries,n=new Array(i.length),o=0;o<i.length;++o)n[o]=this._getVertexBufferLayout(i[o],t.sharedResource,t.geometryIndex);var a={geometryBuffer:t.geometryBuffer,geometryData:t.allGeometryData[0],geometryIndex:t.geometryIndex,layouts:n,mbs:e.mbs,obb:e.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",a,{transferList:[t.geometryBuffer]}):j.ensureDracoDecoder(a).then(function(){return r._controller.reschedule(e.index,a).then(function(e){return r._worker.transform(e)})})},s.prototype.addCachedGPUData=function(e,t,r){if(this._controller.isGeometryVisible(e)){this._nodeId2Meta.set(e.index,t),this.updateNodeStatus(e.index,r),t.engineObject.setHidden(t.engineObject.geometryRecords[0],!1);for(var i=0,n=t.engineObject.getGeometryRecords();i<n.length;i++)n[i].material.updateParameters({slicePlaneEnabled:this.slicePlaneEnabled});this._updateEngineObject(t),this._highlights.objectCreated(t.engineObject)}else{var o=this._controller.indexDepth-e.level+1;this._memCache.put(this._getMemCacheKey(e.index),t,e.memory,o)}},s.prototype.addCachedNodeData=function(e,t,r){var i=this;return this._addData(e,r,function(){return i._addCachedNodeData(e,t)})},s.prototype._addCachedNodeData=function(e,t){var r=this;if(this.suspended||!this._controller.isGeometryVisible(e))return _.resolve();var i=t.geometryData,n=t.transformedGeometries,o=t.sharedResource,a=this.rendererNeedsTextures?t.textureData:null,s={};s[ce.OBJECT]={},s[ce.GEOMETRY]={},s[ce.MATERIAL]={};var l=0,d=!1;e.memory=0;var u=i.componentOffsets,c=i.geometries,h=i.featureIds,p=null,f=null;if(this._hasSymbolColors){p=this._componentColorManager.getBuffer(h.length),f=new Uint16Array(h.length);for(var g=0;g<h.length;g++)f[g]=p.acquireIndex()}for(var y,m=e.id+"|"+h[0],v=new Array,b=new Array,x=new Array,w=new Array,C=this.view,S=0,D=c;S<D.length;S++){var I=D[S],P=n[l++],N=this._createEngineMaterial(e,I,o,a,P.layout);y=P.corMatrices.globalTrafo,d=d||P.hasColors;var O=new re(new Float32Array(P.interleavedVertexData),P.layout,P.positionData,u||re.DefaultOffsets,P.indices||re.DefaultIndices);this._hasSymbolColors&&this._setComponentIndices(O,f);var V=null!=I.transformation?M.mat4f64.clone(I.transformation):ve,T=v.length,L=new $(O,m+(T>0?"_"+T:"")),E=C.renderSpatialReference;v.push(L),x.push(V),w.push(N);var R=U.createOrigin(e.mbs,this.elevationOffset,this._controller.crsIndex,E);b.push(R),e.memory+=this.memEstimateGeometryAdded(L.data),s[ce.MATERIAL][N.id]=N,s[ce.GEOMETRY][L.id]=L}var A={nodeIndex:e.index,layerUid:this._layerUid},j=new te({idHint:e.id,name:m,geometries:v,materials:w,transformations:x,origins:b,castShadow:!0,metadata:A});j.objectTransformation=y,s[ce.OBJECT][j.id]=j;var F=this._addTasks.get(e.index),G=new ge;G.node=e,G.engineObject=j,G.featureIds=h,G.componentColorBuffer=p,G.componentIndices=f,G.cachedRendererVersion=this._getInvalidRendererVersion(),G.cachedSymbolInfos=[],G.attributeInfo=F.attributeInfo,!this._hasTextures&&e.resources.texture&&(this._hasTextures=!0),this._hasColors||(this._hasColors=d),this._hasData=!0,this.notifyChange("hasTexturesOrVertexColors");var B=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(G).then(function(){var t=r._stageLayer,i=r._stage,n=s[ce.OBJECT];for(var o in n)n.hasOwnProperty(o)&&t.addObject(n[o]);for(var a in s)if(s.hasOwnProperty(a)){var l=s[a];for(var d in l)l.hasOwnProperty(d)&&null==i.get(a,d)&&i.add(a,l[d])}if(r._nodeId2Meta.set(e.index,G),r.suspended)r._removeNodeStageData(e.index);else{G.attributeInfo=F.attributeInfo,G.cachedRendererVersion===r._rendererVersion&&B===r.slicePlaneEnabled||r._addOrUpdateEdgeRendering(G),r._setObjectSymbology(G),r._applyFiltersToNode(G)&&r._updateEdgeRendering(G),r.visibleGeometryChanged(j),r._highlights.objectCreated(j);for(var u=0,c=G.engineObject.getGeometryRecords();u<c.length;u++)c[u].material.updateParameters({slicePlaneEnabled:r.slicePlaneEnabled});r._markParentsAsHole(e.index)}})},s.prototype._addData=function(e,t,i){var n=this,o=this._addTasks.get(e.index);return o?o.attributeInfo=t:(o=r({},_.createResolver(),{attributeInfo:t}),this._addTasks.set(e.index,o),i().then(o.resolve,o.reject).then(function(){return n._addTasks.delete(e.index)}).catch(function(t){throw n._addTasks.delete(e.index),t})),o.promise},s.prototype._markParentsAsHole=function(e){if(this._isIntegratedMesh)for(var t=this._controller,r=t.getParentIndex(e);r;r=t.getParentIndex(r))this.updateNodeStatus(r,"hole")},s.prototype._clippingAreaChanged=function(){var e=V.create();X.extentToBoundingBox(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)},s.prototype._filterChange=function(){this._applyFilters(!1)},s.prototype._applyFilters=function(e){var t=this;this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(function(e){t._applyFiltersToNode(e)&&(t._addOrUpdateEdgeRendering(e),t.visibleGeometryChanged(e.engineObject))})},s.prototype.getFilters=function(){var e=this,t=[];return this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,r,e._clippingArea)}),t},s.prototype.addSqlFilter=function(e,t,r,i){var n=this;t&&r&&e.push(function(e,o){return n._sqlFilter(e,o,t,r,i)})},s.prototype._sqlFilter=function(e,t,r,i,n){var o={},a=this._createLayerGraphic(o),s=this.layer.objectIdField,l=t.featureIds,d=t.attributeInfo.attributeData;i.every(function(e){return null!=d[e]||e===s})&&k.filterInPlace(e,l,function(e){o[s]=l[e];for(var t=0,u=i;t<u.length;t++){var c=u[t];c!==s&&(o[c]=k.getCachedAttributeValue(d[c],e))}try{return r.testFeature(a)}catch(e){return n(e),!1}})},s.prototype._boundingboxNodeTest=function(e,t){return X.mbsToMbs(e.node.mbs,this._controller.crsIndex,Se,this.view.renderSpatialReference),k.intersectBoundingBoxWithMbs(t,Se)},s.prototype._boundingboxFeatureTest=function(e,t,r){var i=e.engineObject.geometryRecords[0].geometry;return V.intersects(r,i.getComponentAABB(t,xe))},s.prototype._boundingboxFilter=function(e,t,r){var i=this,n=this._boundingboxNodeTest(t,r);if(3!==n){if(0===n)return void(e.length=0);if(t.engineObject.geometryRecords[0].geometry.componentCount===t.featureIds.length){var o=k.getClipAABB(r,t.engineObject);k.filterInPlace(e,t.featureIds,function(e){return i._boundingboxFeatureTest(t,e,o)})}}},s.prototype._addOrUpdateEdgeRendering=function(e,t){if(void 0===t&&(t=!0),!this._edgeView)return _.resolve();var r=e.engineObject,i=this._edgeView.hasObject(r),n=this._extractObjectEdgeMaterials(e),o=n.hasEdges,a=n.perFeatureEdgeMaterials,s={slicePlaneEnabled:this.slicePlaneEnabled};if(o){var l=!r.isHidden(r.geometryRecords[0]);if(i)this._edgeView.updateAllComponentMaterials(r,a,s,t),this._edgeView.updateObjectVisibility(r,l);else if(l)return d.safeCast(this._edgeView.addObject(r,a,s,!1))}else i&&this._edgeView.removeObject(r);return _.resolve()},s.prototype._removeEdgeRendering=function(e){this._edgeView&&this._edgeView.hasObject(e.engineObject)&&this._edgeView.removeObject(e.engineObject)},s.prototype._applyFiltersToNode=function(e){var t=e.engineObject,r=t.areAllComponentsVisible();if(t.unhideAllComponents(),0===this._filters.length)return!r;var i=e.featureIds;null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters);var n=e.filteredIds;if(n===i)return!r;for(var o=t.getGeometryRecords()[0],a=0,s=0;s<i.length;s++){var l=i[s];a>=n.length||n[a]!==l?t.setComponentVisibility(o,s,!1):a++}return!0},s.prototype._computeFilteredIds=function(e){for(var t=e.featureIds.slice(),r=0,i=this._filters;r<i.length;r++)(0,i[r])(t,e);return t.length===e.featureIds.length?e.featureIds:t},s.prototype._removeAllNodeDataFromStage=function(e){var t=this;void 0===e&&(e=this.elevationOffset),this._nodeId2Meta.forEach(function(r,i){return t._removeNodeStageData(i,e)})},s.prototype.removeNodeData=function(e,t){for(;e.length>0&&!t.done;){var r=e.pop();this._removeNodeStageData(r),t.madeProgress()}},s.prototype._removeNodeStageData=function(e,t){void 0===t&&(t=this.elevationOffset);var r=this._nodeId2Meta.get(e);if(r){var i=r.engineObject;i.setHidden(i.geometryRecords[0],!0),this.visibleGeometryChanged(i),this._removeEdgeRendering(r),this._nodeId2Meta.delete(e),this._highlights.objectDeleted(i);var n=this._controller.indexDepth-r.node.level+1;this._memCache.put(this._getMemCacheKey(e,t),r,r.node.memory,n)}},s.prototype._deleteNodeStageData=function(e){var t=this._stage,r=this._stageLayer,i=e.engineObject;this._edgeView&&this._edgeView.removeObject(i),r.removeObject(i);for(var n=0,o=i.getGeometryRecords();n<o.length;n++){var a=o[n];this.memEstimateGeometryRemoved(a.geometry.data),t.remove(ce.GEOMETRY,a.geometry.id),this._removeMaterial(a.material,t)}if(e.componentIndices){for(var s=0;s<e.componentIndices.length;s++)e.componentColorBuffer.releaseIndex(e.componentIndices[s]);this._componentColorManager.garbageCollect()}t.remove(ce.OBJECT,i.id)},s.prototype._removeMaterial=function(e,t){t.remove(ce.MATERIAL,e.id);var r=e.metadata.engineTex;r&&(this.memEstimateTextureRemoved(r),t.remove(ce.TEXTURE,r.id))},s.prototype.updateNodeStatus=function(e,t){var r=this._nodeId2Meta.get(e);if(r)for(var i="hole"===t,n=0,o=r.engineObject.getGeometryRecords();n<o.length;n++){o[n].material.updateParameters({polygonOffsetEnabled:!this._isIntegratedMesh&&i,readStencil:!!this._isIntegratedMesh&&i})}},s.prototype._getInvalidRendererVersion=function(){return k.addWraparound(this._rendererVersion,-1)},s.prototype._rendererChange=function(e){return a(this,void 0,void 0,function(){var t,r,i,n,a,s,l,d;return o(this,function(o){switch(o.label){case 0:return this._currentRenderer=e,this.notifyChange("rendererNeedsTextures"),this._rendererVersion=k.addWraparound(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,e?(t=this,r=k.findFieldsCaseInsensitive,[4,e.getRequiredFields(this.layer.fields)]):[3,2];case 1:t._rendererFields=r.apply(void 0,[o.sent(),this.layer.fields]),o.label=2;case 2:if(e&&"visualVariables"in e&&e.visualVariables)for(i=0,n=e.visualVariables;i<n.length;i++)"color"===(a=n[i]).type?this._colorVariable=a:"opacity"===a.type?this._opacityVariable=a:he.warn("Unsupported visual variable type for 3D Object Scene Services: "+a.type);if(e)for(s=0,l=e.getSymbols();s<l.length;s++)"mesh-3d"!==(d=l[s]).type&&he.error("Symbols of type '"+d.type+"' are not supported for 3D Object Scene Services.");return this._controller&&this._controller.requestUpdate(),[2]}})})},s.prototype._getSymbolInfos=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolInfos},s.prototype._getSymbolColors=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolColors},s.prototype._updateCachedRendererData=function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t=e.featureIds?e.featureIds.length:1,r={},i=this._tmpAttributeOnlyGraphic;i.attributes=r;var n=this._currentRenderer,o=e.attributeInfo.attributeData,a=null!=e.featureIds?this.layer.objectIdField:null,s=null!=o?this._rendererFields:null;null==e.cachedSymbolColors&&(e.cachedSymbolColors=new Uint8Array(4*e.featureIds.length));for(var l=e.cachedSymbolColors,d=!0,u=0;u<t;u++){if(null!=a&&(r[a]=e.featureIds[u]),null!=s)for(var c=0,h=s;c<h.length;c++){var p=h[c];o[p]&&(r[p]=k.getCachedAttributeValue(o[p],u))}var f=n&&n.getSymbol(i,{arcadeUtils:E}),g=null;f instanceof R&&(this._symbolInfos.has(f.id)||this._symbolInfos.set(f.id,k.getSymbolInfo(f)),g=this._symbolInfos.get(f.id)),e.cachedSymbolInfos[u]=g;var y=null,m=null,v=!0,_=!0;if(n&&"visualVariables"in n){if(this._colorVariable){var b=L.getColor(this._colorVariable,i,{color:Ce});b&&((y=we)[0]=b.r/255,y[1]=b.g/255,y[2]=b.b/255,this._opacityVariable||null===b.a||(m=b.a))}this._opacityVariable&&(m=L.getOpacity(this._opacityVariable,i))}if(g&&g.material){var x=g.material;y=null==y||null==m?F.overrideColor(y,m,x.color,x.alpha,pe,we):F.overrideColor(y,m,null,null,pe,we),W.encodeSymbolColor(y,x.colorMixMode,l,4*u),v=g.castShadows}else W.encodeSymbolColor(null,null,l,4*u),v=!0;if(u>0&&d){for(var w=4*(u-1);w<4*u;w++)l[w]!==l[w+4]&&(d=!1);v!==_&&(d=!1)}_=v}e.uniformSymbolColor=d}},s.prototype._extractObjectEdgeMaterials=function(e){for(var t=[],r=e.engineObject,i=e.featureIds?e.featureIds.length:1,n={opacity:this.fullOpacity},o=this._edgeView.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0}),a=!1,s=null,l=null,d=this._getSymbolInfos(e),u=0;u<i;u++){var c=d[u];r.getComponentVisibility(r.getGeometryRecords()[0],u)&&c?(l!==c&&(l=c,(s=H.createMaterialFromEdges(this._edgeView,c.edges,n))&&(a=!0)),t.push(m.isSome(s)?s:o)):t.push(o)}return{hasEdges:a,perFeatureEdgeMaterials:t}},s.prototype._setObjectSymbology=function(e){if(this._hasSymbolColors){var t=e.featureIds?e.featureIds.length:1,r=this._getSymbolColors(e);if(e.uniformSymbolColor){var i=W.decodeSymbolColor(r,0),n=i.color,o=i.colorMixMode,a=!0;e.cachedSymbolInfos[0]&&(a=e.cachedSymbolInfos[0].castShadows);for(var s=0,l=e.engineObject.getGeometryRecords();s<l.length;s++){l[s].material.updateParameters({componentData:{castShadows:a,externalColor:n,externalColorMixMode:o}})}var d=n[3]<1;this._updateObjectOpacity(e.engineObject,d)}else{for(var u=e.componentColorBuffer.textureBuffer,c=!0,h=0;h<t;h++){var p=4*h,f=e.componentIndices[h],g=1;e.cachedSymbolInfos[h]&&(g=!0===e.cachedSymbolInfos[h].castShadows?1:0),u.setData(f,0,r[p],r[p+1],254&r[p+2]|g,r[p+3]),c=c&&W.isOpaqueSymbolColor(r,p)}for(var y=0,m=e.engineObject.getGeometryRecords();y<m.length;y++){m[y].material.updateParameters({componentData:u})}this._updateObjectOpacity(e.engineObject,!c),this._stage.renderView.setNeedsRender()}}},s.prototype._setComponentIndices=function(e,t){for(var r=e.getAttribute(ne.VertexAttrConstants.COMPONENTINDEX),i=r.data,n=r.offsetIdx,o=r.strideIdx,a=e.getIndices(ne.VertexAttrConstants.COMPONENTINDEX),s=0;s<t.length;s++)for(var l=e.componentOffsets[s],d=e.componentOffsets[s+1],u=l;u<d;u++){i[n+a[u]*o]=t[s]}},s.prototype._reloadAll=function(e){void 0===e&&(e=this.elevationOffset),this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()},s.prototype._opacityChange=function(e){var t=this;this._nodeId2Meta.forEach(function(e){t._updateObjectOpacity(e.engineObject),t._updateEdgeRendering(e)})},s.prototype._updateObjectOpacity=function(e,t){for(var r=0,i=e.getGeometryRecords();r<i.length;r++){var n=i[r].material,o=n.metadata;void 0!==t&&(o.symbolIsTransparent=t);var a=this._calcEngineMaterialTransparencyParams(o.i3sTex,o.i3sMatParams,o.symbolIsTransparent);n.updateParameters(a)}},s.prototype._updateEngineObject=function(e){this._setObjectSymbology(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this.visibleGeometryChanged(e.engineObject)},s.prototype._slicePlaneEnabledChange=function(e){var t=this,r={slicePlaneEnabled:e};this._stageLayer.isSliceable=e,this._nodeId2Meta.forEach(function(e){for(var i=0,n=e.engineObject.getGeometryRecords();i<n.length;i++)n[i].material.updateParameters(r);t._updateEdgeRendering(e,!1)})},s.prototype._updateEdgeRendering=function(e,t){void 0===t&&(t=!0),this._edgeView&&this._edgeView.hasObject(e.engineObject)&&this._addOrUpdateEdgeRendering(e,t)},s.prototype._forAllFeatures=function(e,t,r){var i=this;void 0===r&&(r=0),f.everyMap(this._nodeId2Meta,function(n,o){if(m.isSome(t))switch(t(n)){case 0:return!1;case 2:return!0}return 0!==i._forAllFeaturesOfNode(n,e,r)})},s.prototype._forAllFeaturesOfNode=function(e,t,r){void 0===r&&(r=0);var i=e.featureIds,n=e.engineObject.geometryRecords[0],o=2===r&&this._clippingArea?k.getClipAABB(this._clippingArea,e.engineObject):null,a=o?this._boundingboxNodeTest(e,this._clippingArea):3;if(0===a)return 1;for(var s=0;s<i.length;s++)if(e.engineObject.getComponentVisibility(n,s)||1===r||2===r&&(3===a||this._boundingboxFeatureTest(e,s,o))){var l=t(i[s],s,e,n);switch(l){case 0:return l}}return 1},s.prototype._createGraphic=function(e,t){var r={};null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]);var i=t.attributeInfo.attributeData;if(null!=i)for(var n=0,o=Object.keys(i);n<o.length;n++){var a=o[n];r[a]=k.getCachedAttributeValue(i[a],e)}return this._createLayerGraphic(r)},s.prototype._boundingBoxCornerPoints=function(e,t,r){for(var i=t.geometries[0].getComponentAABB(e,be),n=0;n<8;++n)_e[0]=1&n?i[0]:i[3],_e[1]=2&n?i[1]:i[4],_e[2]=4&n?i[2]:i[5],N.vec3.transformMat4(_e,_e,t.objectTransformation),r[3*n]=_e[0],r[3*n+1]=_e[1],r[3*n+2]=_e[2];return r},s.prototype.highlight=function(e,t){var r=this;void 0===t&&(t={});var i=this._highlights;if("number"==typeof e?e=[e]:e instanceof l?e=[e]:e instanceof u&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof l){var n=e.map(function(e){return q.attributeLookup(e.attributes,r._getObjectIdField())}),o=i.acquireSet(t),a=o.set,s=o.handle;return i.setFeatureIds(a,n),s}if("number"==typeof e[0]){n=e;var d=i.acquireSet(t);a=d.set,s=d.handle;return i.setFeatureIds(a,n),s}}return De},s.prototype.visibleGeometryChanged=function(e){var t=this;e?this._elevationProvider.objectChanged(e):this._elevationProvider.layerChanged(),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=x.schedule(function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))},s.prototype.test=function(){var e=this;return{controller:this._controller,get visibleObjectIds(){var t=[];return e._forAllFeatures(function(e,r,i,n){return i.engineObject.isHidden(n)||i.engineObject.areAllComponentsHidden()||!i.engineObject.getComponentVisibility(n,r)||t.push(e),1}),t.sort(function(e,t){return e-t}),t},get numNodes(){return e._nodeId2Meta.size}}},n([P.property()],s.prototype,"view",void 0),n([P.property()],s.prototype,"layer",void 0),n([P.property()],s.prototype,"_controller",void 0),n([P.property({dependsOn:["_controller.updating"]})],s.prototype,"updating",void 0),n([P.property({dependsOn:["_controller.rootNodeVisible"]})],s.prototype,"suspended",void 0),n([P.property(Q.updatingPercentage)],s.prototype,"updatingPercentage",void 0),n([P.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],s.prototype,"updatingPercentageValue",void 0),n([P.property({readOnly:!0})],s.prototype,"hasTexturesOrVertexColors",null),n([P.property({readOnly:!0})],s.prototype,"rendererNeedsTextures",null),n([P.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],s.prototype,"elevationOffset",null),n([P.property({type:Boolean})],s.prototype,"slicePlaneEnabled",void 0),n([P.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],s.prototype,"uncompressedTextureDownsamplingEnabled",null),n([P.property({dependsOn:["layer.version"]})],s.prototype,"useCompressedTextures",null),n([P.subclass("esri.views.3d.layers.I3SMeshView3D")],s)}(P.declared(h,c,v));t.I3SMeshView3D=me;var ve=M.mat4f64.create(),_e=O.vec3f64.create(),be=V.create(),xe=V.create(),we=[0,0,0,0],Ce=new s([0,0,0,0]),Se=[0,0,0,0],De={remove:function(){},pause:function(){},resume:function(){}}}.apply(null,i))||(e.exports=n)},1624:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(1529)],void 0===(n=function(e,t,r){var i=function(){return function(e){this.highlightSet=new r,this.ids=new Set,this.paused=!1,this.options=e}}();return function(){function e(e){this.highlights=[],this.layerView=e}return e.prototype.destroy=function(){this.highlights.forEach(function(e){return e.highlightSet.removeAll()}),this.highlights=null},e.prototype.acquireSet=function(e){var t=this,r=new i(e);return this.highlights.push(r),{set:r,handle:{remove:function(){return t.releaseSet(r)},pause:function(){r.highlightSet.removeAll(),r.paused=!0},resume:function(){r.paused=!1,t.initializeSet(r)}}}},e.prototype.releaseSet=function(e){e.highlightSet.removeAll();var t=this.highlights?this.highlights.indexOf(e):-1;-1!==t&&this.highlights.splice(t,1)},e.prototype.setFeatureIds=function(e,t){t.forEach(function(t){return e.ids.add(t)}),this.initializeSet(e)},e.prototype.initializeSet=function(e){this.layerView._forAllFeatures(function(t,r,i,n){if(e.ids.has(t)){var o=i.engineObject.setComponentHighlight(n,r,e.options);e.highlightSet.addObject(i.engineObject,o)}return 1},null,1)},e.prototype.objectCreated=function(e){var t=this;this.highlights.forEach(function(r){r.paused||t.layerView._forAllFeaturesOfNode(t.layerView._getMetadata(e),function(t,i,n,o){if(r.ids.has(t)){var a=e.setComponentHighlight(o,i,r.options);r.highlightSet.addObject(e,a)}return 1},1)})},e.prototype.objectDeleted=function(e){this.highlights.forEach(function(t){t.highlightSet.removeObject(e)})},e.prototype.allObjectsDeleted=function(){this.highlights.forEach(function(e){return e.highlightSet.removeAll()})},e}()}.apply(null,i))||(e.exports=n)},1625:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(1),r(6),r(37),r(12),r(0),r(4),r(3),r(35),r(95),r(173)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h){var p=u.empty(),f={spatialReference:null,extent:p},g=d.vec3f64.create(),y=d.vec3f64.create(),m=d.vec3f64.create(),v=a.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider");return function(e){function t(t){return e.call(this)||this}return r(t,e),t.prototype.initialize=function(){var e=this.layerView.view;this.view=e,this.renderCoordsHelper=e.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=new h(e.viewingMode);var t=this.layerView.layer.fullExtent;this.zmin=t.zmin,this.zmax=t.zmax},t.prototype.getElevation=function(e){if(c.isPoint(e)){if(!this.renderCoordsHelper.toRenderCoords(e,g))return v.error("could not project point for elevation alignment"),-1/0}else if(!this.renderCoordsHelper.toRenderCoords(e,this.spatialReference,g))return v.error("could not project point for elevation alignment"),-1/0;var t=this.layerView.elevationOffset,r=this.zmin+t,i=this.zmax+t;return l.vec3.copy(y,g),l.vec3.copy(m,g),this.renderCoordsHelper.setAltitude(i,y),this.renderCoordsHelper.setAltitude(r,m),this.intersector.intersect(this.intersectLayers,y,m,null,null,1,!1),this.intersector.results.min.getIntersectionPoint(g)?this.renderCoordsHelper.getAltitude(g):-1/0},t.prototype.layerChanged=function(){this.spatialReference&&(f.extent=this.computeLayerExtent(this.intersectLayers[0]),f.spatialReference=this.spatialReference,this.emit("elevation-change",f))},t.prototype.objectChanged=function(e){this.spatialReference&&(f.extent=this.computeObjectExtent(e),f.spatialReference=this.spatialReference,this.emit("elevation-change",f))},t.prototype.computeObjectExtent=function(e){return u.empty(p),this.expandExtent(e,p),p},t.prototype.computeLayerExtent=function(e){u.empty(p);for(var t=0,r=e.getObjects();t<r.length;t++){var i=r[t];this.expandExtent(i,p)}return p},t.prototype.expandExtent=function(e,t){for(var r=e.getBBMin(!0),i=e.getBBMax(!0),n=0;n<8;++n)g[0]=1&n?r[0]:i[0],g[1]=2&n?r[1]:i[1],g[2]=4&n?r[2]:i[2],l.vec3.transformMat4(g,g,e.objectTransformation),this.renderCoordsHelper.fromRenderCoords(g,g,this.spatialReference),u.expand(t,g);return t},i([s.property({constructOnly:!0})],t.prototype,"layerView",void 0),i([s.property({constructOnly:!0})],t.prototype,"stageLayer",void 0),i([s.property()],t.prototype,"view",void 0),i([s.property({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],t.prototype,"spatialReference",void 0),i([s.subclass("esri.views.3d.layers.i3s.I3SElevationProvider")],t)}(s.declared(n,o))}.apply(null,i))||(e.exports=n)},1626:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(15),r(9)],void 0===(n=function(e,t,r,i){function n(e){return i.create(function(t,r){e.oncomplete=function(){return t()},e.onerror=function(){return r(e.error)},e.onabort=function(){return r(e.error)}})}function o(e){return i.create(function(t,r){"done"===e.readyState?null!=e.error?r(e.error):t(e.result):(e.onsuccess=function(){return t(e.result)},e.onerror=function(){return r(e.error)})})}Object.defineProperty(t,"__esModule",{value:!0});var a=14,s=function(){function e(e,t,r){void 0===r&&(r=a),this._version=r,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=e,this._storeName=t}return e.prototype.init=function(){var e=this;return i.resolve().then(function(){var t=indexedDB.open(e._dbName,e._version);return t.onupgradeneeded=function(r){var i=t.result,n=t.transaction,o=i.objectStoreNames.contains(e._storeName)?n.objectStore(e._storeName):i.createObjectStore(e._storeName),a=i.objectStoreNames.contains("last_access")?n.objectStore("last_access"):i.createObjectStore("last_access");a.indexNames.contains("date")||a.createIndex("date","date",{unique:!1}),a.indexNames.contains("byteSize")||a.createIndex("byteSize","byteSize",{unique:!1}),r.oldVersion<e._version&&(o.clear(),a.clear())},o(t)}).then(function(t){e._destroyed?t.close():e._db=t})},e.prototype.destroy=function(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0},Object.defineProperty(e.prototype,"initialized",{get:function(){return null!=this._db},enumerable:!0,configurable:!0}),e.prototype.getHitRate=function(){return this._hit/(this._hit+this._miss)},e.prototype.put=function(e,t){var n=this;return null==this._db?i.reject(new r("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:i.resolve()).then(function(){return n._put(e,t)}).catch(function(r){if(r&&"QuotaExceededError"===r.name)return null==n._quotaReductionPromise&&(n._quotaReductionPromise=n._getCacheSize().then(function(e){return n._removeLeastRecentlyAccessed(t.byteSize+Math.ceil(e*n.quotaReductionFactor))}),n._quotaReductionPromise.then(function(){return n._quotaReductionPromise=null},function(){return n._quotaReductionPromise=null})),n._quotaReductionPromise.then(function(){return n._put(e,t)});throw r}).then(function(){--n._gcCounter<0&&null!=n._db&&(n._gcCounter=n.gcFrequency,n._getCacheSize().then(function(e){return n._removeLeastRecentlyAccessed(e-n.maxByteSize)}))})},e.prototype.get=function(e){var t=this;return null==this._db?i.resolve(null):i.resolve().then(function(){return o(t._db.transaction(t._storeName,"readonly").objectStore(t._storeName).get(e))}).then(function(r){if(null==r)++t._miss;else if(t._db){++t._hit,t._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:r.byteSize},e)}return r}).catch(function(e){return++t._miss,null})},e.prototype.remove=function(e){var t=this;return null==this._db?i.resolve():i.resolve().then(function(){var r=t._db.transaction([t._storeName,"last_access"],"readwrite"),a=r.objectStore(t._storeName),s=r.objectStore("last_access"),l=a.delete(e),d=s.delete(e);return i.all([o(l),o(d),n(r)])})},e.prototype._put=function(e,t){var r=this._db.transaction([this._storeName,"last_access"],"readwrite"),a=r.objectStore(this._storeName),s=r.objectStore("last_access"),l=a.put(t,e),d=s.put({date:Date.now(),byteSize:t.byteSize},e);return i.all([o(l),o(d),n(r)])},e.prototype._removeLeastRecentlyAccessed=function(e){if(!(e<=0)){var t=this._db.transaction([this._storeName,"last_access"],"readwrite"),r=t.objectStore(this._storeName),i=t.objectStore("last_access"),o=0,a=i.index("date").openCursor(null,"next");return a.onsuccess=function(t){var n=a.result;null!=n&&(null!=n.value.byteSize&&(o+=n.value.byteSize),r.delete(n.primaryKey),i.delete(n.primaryKey),o<e&&n.continue())},n(t)}},e.prototype._getCacheSize=function(){var e=this._db.transaction("last_access"),t=0,r=e.objectStore("last_access").index("byteSize").openKeyCursor();return r.onsuccess=function(e){var i=r.result;if(i){var n=i.key;null!=n&&(t+=n),i.continue()}},n(e).then(function(){return t})},e}();t.IDBCache=s,t.whenTransaction=n,t.whenRequest=o}.apply(null,i))||(e.exports=n)},1627:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(1628),r(1546)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.create=function(e,t,i){return new r.ComponentMaterial(e,t,i)},e.vertexBufferLayout=i.createVertexBufferLayout}(t.ComponentMaterial||(t.ComponentMaterial={}))}.apply(null,i))||(e.exports=n)},1628:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(5),r(7),r(14),r(122),r(1629),r(1545),r(1546),r(58),r(1631)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u){Object.defineProperty(t,"__esModule",{value:!0});var c=function(e){function t(t,r,i){var n=e.call(this,i)||this;return n.supportsEdges=!0,n._parameters=s.fillDefaults(t),n._geometryParameters=r,n}return r(t,e),Object.defineProperty(t.prototype,"parameters",{get:function(){return this._parameters},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"geometryParameters",{get:function(){return this._geometryParameters},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasTransparency",{get:function(){var e=this._parameters.forceTransparency;if(n.isSome(e))return e;if(this._parameters.baseColorOpacity<1||this._parameters.layerOpacity<1)return!0;var t=this._parameters.componentData;return!s.isUniformComponentData(t)||"replace"!==t.externalColorMixMode||t.externalColor[3]<1},enumerable:!0,configurable:!0}),t.prototype.isVisibleInPass=function(e){if(3!==e)return!0;var t=this._parameters.componentData;return!s.isUniformComponentData(t)||t.castShadows},t.prototype.isVisible=function(){var t=this.parameters;if(!e.prototype.isVisible.call(this))return!1;if(0===t.layerOpacity)return!1;var r=t.componentData;return!s.isUniformComponentData(r)||("replace"===r.externalColorMixMode?r.externalColor[3]>0:t.baseColorOpacity>0)},t.prototype.updateParameters=function(e){var t=!1;for(var r in e){var i=this._parameters[r],n=e[r];i!==n&&(t=!0,this._parameters[r]=n)}return t&&this.notifyDirty("matChanged"),t},t.prototype.intersect=function(e,t,r,i,n,o,a){d.intersectTriangleGeometry(e,t,r,i,n,o,a)},t.prototype.getGLMaterials=function(){return{color:a.GLMaterialColor,depthShadowMap:a.GLMaterialDepthShadowMap,normal:a.GLMaterialNormal,depth:a.GLMaterialDepth,highlight:a.GLMaterialHighlight}},t.prototype.createRenderer=function(e,t){return new u(e,t,this)},t.prototype.createBufferWriter=function(){throw Error("Not supported")},t.prototype.createBufferLayout=function(){return l.createVertexBufferLayout(this.geometryParameters)},t}(o);t.ComponentMaterial=c}.apply(null,i))||(e.exports=n)},1629:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(5),r(1),r(213),r(585),r(139),r(1545),r(58),r(58),r(1630),r(589),r(44)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h){function p(e){if(function(e){return"none"!==e.parameters.cullFace}(e))return{face:"front"===e.parameters.cullFace?1028:1029,mode:2305}}Object.defineProperty(t,"__esModule",{value:!0});var f=function(e){function t(t,r,i,n){var a=e.call(this,r,i)||this;a._passName=t,a.material=r;var s=r.parameters;return a._baseColorTexture=new u.TextureBinding(n,s.baseColorTexture,{textureUniform:"tex",textureSizeUniform:"texSize",textureUnit:o.DefaultTextureUnits.DIFFUSE}),a.createPrograms(),a.selectPipeline(),a.selectSlot(),a}return r(t,e),t.prototype.createPrograms=function(){var e=this;this.programs=l.BindParametersMap.create(this.material.parameters,function(t){return e._createProgram(t)})},t.prototype._createProgram=function(e){var t=this.material.parameters,r=this.material.geometryParameters,i=t.baseColorTexture?r.textureCoordinateRegions?"AtlasTextured":"Textured":"none",n="screen-space"===t.normals||"screen-space"===r.normals||"none"===r.normals?"screenDerivative":"compressed"===r.normals?"compressed":"default";return"color"===this._passName?this.programRep.getProgram(c.colorPass,{textureMode:i,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,doubleSided:t.doubleSidedShading,groundNormalShading:"ground"===t.normals,normals:n,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled,receiveShadows:e.receiveShadows,receiveSSAO:e.receiveSSAO}):"depth"===this._passName||"depthShadowMap"===this._passName?this.programRep.getProgram(c.depthPass,{textureMode:i,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:n,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",shadowMap:"depthShadowMap"===this._passName,slice:t.slicePlaneEnabled}):"normal"===this._passName?this.programRep.getProgram(c.normalPass,{textureMode:i,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:n,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled}):"highlight"===this._passName?this.programRep.getProgram(c.highlightPass,{textureMode:i,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:n,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled}):void 0},t.prototype.selectPipeline=function(){var e=this.material.parameters;"color"===this._passName?this.pipelineState=h.makePipelineState({blending:function(e){if(e.hasTransparency)return h.separateBlendingParams(770,1,771,771)}(this.material),culling:p(this.material),polygonOffset:e.polygonOffsetEnabled&&w,stencilTest:e.writeStencil&&{function:{func:e.readStencil?517:519,ref:1,mask:255},operation:{fail:7680,zFail:7680,zPass:7681}},stencilWrite:e.writeStencil&&{mask:255},depthTest:{func:513},depthWrite:h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams}):this.pipelineState=h.makePipelineState({culling:p(this.material),polygonOffset:e.polygonOffsetEnabled&&w,depthTest:{func:513},depthWrite:h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams})},t.prototype.selectSlot=function(){this.slot=this.material.hasTransparency?7:this.material.parameters.readStencil?3:this.material.parameters.writeStencil?2:5},t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getProgram=function(){return this.program||this.getPrograms()[0]},t.prototype.getPrograms=function(){return l.BindParametersMap.programs(this.programs)},t.prototype.updateParameters=function(){var e=this.material.parameters;this._baseColorTexture.update(e.baseColorTexture),this.createPrograms(),this.selectPipeline(),this.selectSlot()},t.prototype.bind=function(e,t){var r=this.material.parameters,i=this.program=l.BindParametersMap.lookup(this.programs,t);e.bindProgram(i),e.setPipelineState(this.pipelineState),i.setUniform3fv("ambient",r.baseColor),i.setUniform3fv("diffuse",r.baseColor),i.setUniform3fv("specular",x),i.setUniform1f("opacity",r.baseColorOpacity),i.setUniform1f("layerOpacity",r.layerOpacity),s.isUniformComponentData(r.componentData)?(i.setUniform4fv("externalColor",r.componentData.externalColor),i.setUniform1i("colorMixMode",d.colorMixModes[r.componentData.externalColorMixMode])):(i.setUniform4fv("externalColor",b),i.setUniform1i("colorMixMode",d.colorMixModes.multiply),this.material.geometryParameters.componentData&&(r.componentData.updateTexture(),r.componentData.bind(i,{texName:"uComponentColorTex",invDimName:"uComponentColorTexInvDim",unit:o.DefaultTextureUnits.COMPONENT_COLOR}))),this._baseColorTexture.bind(e,i),i.setUniform1f("textureAlphaCutoff",.1),"depth"!==this._passName&&"depthShadowMap"!==this._passName||i.setUniform2fv("nearFar",t.nearFar),"highlight"===this._passName&&d.bindHighlightRendering(e,t,i)},t.prototype.bindView=function(e,t){var r=this.material.parameters,i=this.program=l.BindParametersMap.lookup(this.programs,t),n=t.origin;d.bindView(n,t.view,i),d.bindCamPos(n,t.viewInvTransp,i),r.slicePlaneEnabled&&d.bindSlicePlane(n,t.slicePlane,i),"color"===this._passName&&t.shadowMappingEnabled&&t.shadowMap.bindView(i,n),"normal"===this._passName&&i.setUniformMatrix4fv("viewNormal",t.viewInvTransp)},t.prototype.bindInstance=function(e,t){var r=this.program;r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},i([n.autoDispose()],t.prototype,"_baseColorTexture",void 0),t}(a),g=function(e){function t(t,r,i){var n=e.call(this,"color",t,r,i)||this;return n.material=t,n}return r(t,e),t}(f);t.GLMaterialColor=g;var y=function(e){function t(t,r,i){var n=e.call(this,"depth",t,r,i)||this;return n.material=t,n}return r(t,e),t}(f);t.GLMaterialDepth=y;var m=function(e){function t(t,r,i){var n=e.call(this,"depthShadowMap",t,r,i)||this;return n.material=t,n}return r(t,e),t}(f);t.GLMaterialDepthShadowMap=m;var v=function(e){function t(t,r,i){var n=e.call(this,"normal",t,r,i)||this;return n.material=t,n}return r(t,e),t}(f);t.GLMaterialNormal=v;var _=function(e){function t(t,r,i){var n=e.call(this,"highlight",t,r,i)||this;return n.material=t,n}return r(t,e),t}(f);t.GLMaterialHighlight=_;var b=[1,1,1,1],x=[0,0,0],w={factor:2,units:2}}.apply(null,i))||(e.exports=n)},1630:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(14)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,i){var n=this;this._textureRep=e,this._textureId=t,this._options=i,this._textureRef=r.applySome(this._textureId,function(e){return n._textureRep.acquire(e,!!n._options.initTransparent)})}return e.prototype.dispose=function(){var e=this;this._textureRef=r.applySome(this._textureId,function(t){e._textureRep.release(t)})},e.prototype.bind=function(e,t){if(r.isSome(this._textureRef)&&(t.setUniform1i(this._options.textureUniform,this._options.textureUnit),e.bindTexture(this._textureRef.getGLTexture(),this._options.textureUnit),this._options.textureSizeUniform)){var i=this._textureRef.getGLTexture();t.setUniform2f(this._options.textureSizeUniform,i.descriptor.width,i.descriptor.height)}},e.prototype.update=function(e){var t=this;e!==this._textureId&&(r.applySome(this._textureId,function(e){t._textureRep.release(e)}),this._textureRef=r.applySome(e,function(e){return t._textureRep.acquire(e,!!t._options.initTransparent)}))},e}();t.TextureBinding=i}.apply(null,i))||(e.exports=n)},1631:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(21),r(19),r(98),r(50),r(18),r(377),r(378),r(67),r(46),r(70)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c){var h=function(){function e(e,t,r){this._material=r,this._dataByOrigin=new Map,this._highlightCount=0,this._rctx=e,this._materialRep=t,this._glMaterials=l.acquireMaterials(this._material,this._materialRep)}return e.prototype.dispose=function(){l.releaseMaterials(this._material,this._materialRep)},Object.defineProperty(e.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlightCount>0},enumerable:!0,configurable:!0}),e.prototype.hasWater=function(){return!1},e.prototype.renderPriority=function(){return this._material.renderPriority},e.prototype.modify=function(e){this.updateGeometries(e.toUpdate),this.addAndRemoveGeometries(e.toAdd,e.toRemove),this.updateHighlightCount()},e.prototype.addAndRemoveGeometries=function(e,t){var u=this,h=this._rctx,f=this._dataByOrigin;e.forEach(function(e){var t=e.data;if(t.preinterleaved)if(null!=t.vertexData){var g=e.origin.id,y=e.origin.vec3,m=e.uniqueName,v=f.get(g);v||(v={origin:y,highlightCount:0,dataByGeometry:new Map},f.set(g,v)),a.setMatrixTranslation3(p,-y[0],-y[1],-y[2]);var _=i.mat4f64.create();r.mat4.multiply(_,p,e.transformation);var b=l.generateRenderGeometryVisibleIndexRanges(e),x=l.generateRenderGeometryHighlightRanges(e);x&&(v.highlightCount=null);var w=t.indexCount,C=t.id,S=new s(e.name,0,w,b,x,_,e.instanceParameters,e.idx,C),D=t.indexData?d.createIndex(h,35044,t.indexData):null,I=u._material.createBufferLayout(),P=new c(h,o.Default3D,{geometry:n.glLayout(I)},{geometry:d.createVertex(h,35044)},D);P.vertexBuffers.geometry.setData(t.vertexData),t.indexData=null,t.vertexData=null,v.dataByGeometry.set(m,{instance:S,vao:P})}else a.assert(!1,"Trying to re-add preinterleaved geometry data which is no longer available.");else a.assert(!1,"Non-interleaved render geometry processed as pre-interleaved")}),t.forEach(function(e){var t=e.origin.id,r=e.uniqueName,i=f.get(t);i.dataByGeometry.get(r).vao.dispose(),i.dataByGeometry.delete(r),0===i.dataByGeometry.size&&f.delete(t)})},e.prototype.updateGeometries=function(e){var t=this;e.forEach(function(e){var r=e.updateType,i=e.renderGeometry,n=i.origin.id,o=i.uniqueName,a=t._dataByOrigin.get(n),s=a&&a.dataByGeometry.get(o).instance;s&&(1&r&&(s.displayedIndexRange=l.generateRenderGeometryVisibleIndexRanges(i)),17&r&&(s.highlightedIndexRanges=l.generateRenderGeometryHighlightRanges(i),a.highlightCount=null),2&r&&console.error("Updating Preinterleaved geometry not supported"),4&r&&l.calculateTransformRelToOrigin(i,s.transformation,s.transformationNormal))})},e.prototype.updateHighlightCount=function(){var e=this;this._highlightCount=0,this._dataByOrigin.forEach(function(t){if(null==t.highlightCount){var r=0;t.dataByGeometry.forEach(function(e){e.instance.highlightedIndexRanges&&++r}),t.highlightCount=r}e._highlightCount+=t.highlightCount})},e.prototype.render=function(e,t,r,i){var n=this,o=this._rctx,a=this._glMaterials.get(t.pass),s=4===t.pass;if(!a||null!=e&&!a.beginSlot(e)||s&&0===this._highlightCount)return!1;a.bind(o,r);var l=!1;return this._dataByOrigin.forEach(function(e){s&&0===e.highlightCount||(r.origin=e.origin,a.bindView(o,r),s?e.dataByGeometry.forEach(function(e){l=n.renderInstanceHighlight(a,e,i)||l}):e.dataByGeometry.forEach(function(e){l=n.renderInstance(a,e,i)||l}))}),a.release(o,r),o.bindVAO(null),l},e.prototype.renderInstance=function(e,t,r){var i=t.instance,n=t.vao,o=i.displayedIndexRange;if(o&&0===o.length)return!1;var a=this._rctx,s=e.getProgram(),d=e.getDrawMode();u.assertCompatibleVertexAttributeLocations(n,s),a.bindVAO(n),e.bindInstance(a,i);var c=n.indexBuffer&&n.indexBuffer.indexType;if(o)c?l.drawElementsFaceRange(a,o,i.from,d,c,r):l.drawArraysFaceRange(a,o,i.from,d,r);else{var h=i.to-i.from;c?l.drawElements(a,d,c,i.from,h,r):l.drawArrays(a,d,i.from,h,r)}return!0},e.prototype.renderInstanceHighlight=function(e,t,r){var i=t.instance,n=t.vao,o=i.highlightedIndexRanges;if(!o)return!1;var a=this._rctx,s=e.getProgram(),d=e.getDrawMode();u.assertCompatibleVertexAttributeLocations(n,s),a.bindVAO(n),e.bindInstance(a,i);for(var c=n.indexBuffer&&n.indexBuffer.indexType,h=!1,p=0;p<o.length;p++){var f=o[p],g=f.range?f.range[0]+i.from:i.from,y=f.range?f.range[1]-f.range[0]+1:i.to-i.from;c?l.drawElements(a,d,c,g,y,r):l.drawArrays(a,d,g,y,r),h=!0}return h},e}(),p=i.mat4f64.create();return h}.apply(null,i))||(e.exports=n)},2449:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(7),r(2),r(1),r(0),r(1623),r(1476),r(1482)],void 0===(n=function(e,t,r,i,n,o,a,s,l){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lodFactor=1,t._elevationContext="im",t._isIntegratedMesh=!0,t}return i(t,e),Object.defineProperty(t.prototype,"progressiveLoadFactor",{get:function(){return this.lodFactor>=1?.2:1},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){},t.prototype.destroy=function(){},t.prototype._createLayerGraphic=function(e){return null},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return!(!this._controller||!this._controller.updating)},n([o.property()],t.prototype,"layer",void 0),n([o.property({dependsOn:["_controller.updating"]})],t.prototype,"updating",void 0),n([o.property({dependsOn:["_controller.rootNodeVisible"]})],t.prototype,"suspended",void 0),n([o.property(l.updatingPercentage)],t.prototype,"updatingPercentage",void 0),n([o.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),n([o.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.integratedMesh.lodFactor"})],t.prototype,"lodFactor",void 0),n([o.property({readOnly:!0,dependsOn:["lodFactor"]})],t.prototype,"progressiveLoadFactor",null),n([o.subclass("esri.views.3d.layers.SceneLayerView3D")],t)}(o.declared(s,a.I3SMeshView3D))}.apply(null,i))||(e.exports=n)}}]);